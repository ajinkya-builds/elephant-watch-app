import{r as c,T as d,j as e,aB as ne,L as oe,az as le,aA as ce,F as de,X as me}from"./vendor-BN4GkXqm.js";import{s as b}from"./supabase-BJmOsL1c.js";import{B as o}from"./button-BJ90T0vB.js";import{C as he,b as ue,c as pe,a as xe}from"./card-C1KHSlZe.js";import{T as ve,a as _e,b as k,c as _,d as ge,e as p}from"./table-D-PAPVp_.js";import{I as C}from"./input-DE4x_qKG.js";import{L as S}from"./label-6ghtkqW1.js";import"./index-CF756DUw.js";import"./radix-DRLsuDDF.js";const Ae=()=>{const[R,V]=c.useState([]),[g,O]=c.useState(1),[N]=c.useState(10),[A,W]=c.useState(1),[E,Z]=c.useState(0),[f,l]=c.useState(!1),[$,y]=c.useState(null),[T,ee]=c.useState([]),[n,x]=c.useState(null);c.useEffect(()=>{w()},[g]);const w=async()=>{l(!0),y(null);try{const{data:t,error:a,count:m}=await b.from("activity_reports").select(`
          *,
          activity_observation (
            *
          )
        `,{count:"exact"}).order("created_at",{ascending:!1}).range((g-1)*N,g*N-1);if(a)throw a;if(t&&t.length>0){console.log("Fetched observations with report_to_users:",JSON.stringify(t,null,2));const h=t.map(s=>{const v=s.created_at?new Date(s.created_at):new Date,r=s.updated_at?new Date(s.updated_at):new Date;return{id:s.id||"",created_at:v,updated_at:r,user_id:s.user_id||"",activity_date:s.activity_date||v.toISOString().split("T")[0],activity_time:s.activity_time||v.toTimeString().split(" ")[0],latitude:Number(s.latitude)||0,longitude:Number(s.longitude)||0,observation_type:s.observation_type||"direct",status:s.status||"submitted",is_offline:!!s.is_offline,total_elephants:Number(s.total_elephants)||0,damage_done:s.damage_done||!1,damage_description:s.damage_description||"",reporter_mobile:s.reporter_mobile||"",email:s.email||"",associated_division:s.associated_division||"",associated_range:s.associated_range||"",associated_beat:s.associated_beat||"",compass_bearing:s.compass_bearing,indirect_sighting_type:s.indirect_sighting_type,activity_observation:s.activity_observation||[]}});V(h),Z(m||0),W(Math.ceil((m||1)/N))}}catch(t){console.error("Error fetching observations:",t);const a=t instanceof Error?t.message:"Failed to fetch observations";y(a),d.error(a)}finally{l(!1)}},te=async t=>{try{l(!0);const{error:a}=await b.from("activity_reports").update({status:"synced"}).eq("id",t);if(a)throw a;await w(),d.success("Report synced successfully")}catch(a){console.error("Error syncing report:",a),y("Failed to sync report"),d.error("Failed to sync report")}finally{l(!1)}},ae=async t=>{if(confirm("Are you sure you want to delete this report?"))try{l(!0);const{error:a}=await b.from("activity_reports").delete().eq("id",t);if(a)throw a;await w(),d.success("Report deleted successfully")}catch(a){console.error("Error deleting report:",a),y("Failed to delete report"),d.error("Failed to delete report")}finally{l(!1)}},se=async()=>{if(T.length!==0&&confirm("Are you sure you want to delete the selected reports?"))try{l(!0);const{error:t}=await b.from("activity_reports").delete().in("id",T);if(t)throw t;ee([]),await w(),d.success("Selected reports deleted successfully")}catch(t){console.error("Error deleting reports:",t),y("Failed to delete selected reports"),d.error("Failed to delete selected reports")}finally{l(!1)}},re=async()=>{try{const{data:t,error:a}=await b.from("activity_reports").select("*").order("created_at",{ascending:!1});if(a)throw a;const m=[["ID","Date","Status","Type","Elephants","Damage","Reporter","Email","Mobile"].join(","),...(t||[]).map(r=>{const D=r.created_at||new Date;return[`"${r.id||""}"`,`"${D.toLocaleString()}"`,`"${r.status||""}"`,`"${r.observation_type||""}"`,`"${r.total_elephants||0}"`,`"${r.damage_done?"Yes":"No"}"`,`"${r.reporter_name||"N/A"}"`,`"${r.email||""}"`,`"${r.reporter_mobile||""}"`].join(",")})].join(`
`),h=new Blob([m],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),v=URL.createObjectURL(h);s.setAttribute("href",v),s.setAttribute("download",`observations_${new Date().toISOString().split("T")[0]}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(t){console.error("Error exporting data:",t),y("Failed to export data"),d.error("Failed to export data")}},ie=async t=>{if(t.preventDefault(),!(!n||!n.id))try{l(!0);const a=new FormData(t.target),m={activity_date:a.get("activity_date")||"",activity_time:a.get("activity_time")||"",latitude:Number(a.get("latitude"))||0,longitude:Number(a.get("longitude"))||0,observation_type:a.get("observation_type")||"direct",status:a.get("status")||"submitted",is_offline:a.get("is_offline")==="true",reporter_mobile:a.get("reporter_mobile")||"",email:a.get("email")||"",total_elephants:Number(a.get("total_elephants"))||0,damage_done:a.get("damage_done")==="true",damage_description:a.get("damage_description")||"",associated_division:a.get("associated_division")||"",associated_range:a.get("associated_range")||"",associated_beat:a.get("associated_beat")||""},{error:h}=await b.from("activity_reports").update(m).eq("id",n.id);if(h)throw h;x(null),await w(),d.success("Report updated successfully")}catch(a){console.error("Error saving report:",a),y("Failed to save report"),d.error("Failed to save report")}finally{l(!1)}};return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsxs(he,{children:[e.jsx(ue,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(pe,{children:"Observations"}),e.jsxs(o,{onClick:()=>x({}),children:[e.jsx(ne,{className:"w-4 h-4 mr-2"})," Add Observation"]})]})}),e.jsx(xe,{children:f?e.jsx("div",{className:"flex justify-center p-8",children:e.jsx(oe,{className:"w-8 h-8 animate-spin"})}):$?e.jsx("div",{className:"text-red-500 p-4",children:$}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"flex space-x-2",children:e.jsx(o,{variant:"outline",onClick:re,disabled:f,children:"Export"})}),e.jsx(o,{variant:"outline",onClick:se,disabled:T.length===0||f,children:"Delete Selected"})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(ve,{children:[e.jsx(_e,{children:e.jsxs(k,{children:[e.jsx(_,{children:"Date"}),e.jsx(_,{children:"Type"}),e.jsx(_,{children:"Beat"}),e.jsx(_,{children:"Range"}),e.jsx(_,{children:"Division"}),e.jsx(_,{children:"Reported To"}),e.jsx(_,{children:"Sighting Details"}),e.jsx(_,{children:"Actions"})]})}),e.jsx(ge,{children:R.length===0?e.jsx(k,{children:e.jsx(p,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:"No observations found"})}):R.map(t=>{var a,m,h,s,v,r,D,L,B,z,M,P,I,H,q,U,Y,J,X,G;return e.jsxs(k,{children:[e.jsx(p,{children:new Date(t.activity_date).toLocaleDateString()}),e.jsx(p,{className:"capitalize",children:t.observation_type}),e.jsx(p,{children:t.associated_beat||"N/A"}),e.jsx(p,{children:t.associated_range||"N/A"}),e.jsx(p,{children:t.associated_division||"N/A"}),e.jsx(p,{children:(()=>{var K,Q;try{const i=(Q=(K=t.activity_observation)==null?void 0:K[0])==null?void 0:Q.report_to_users;if(console.log("Report to users for observation",t.id,":",i),!i)return"N/A";if(typeof i=="object"&&!Array.isArray(i)){if("name"in i&&typeof i.name=="string")return i.name;const u=Object.values(i).filter(j=>j!==null&&typeof j=="object"&&"name"in j&&typeof j.name=="string").map(j=>j.name);return u.length>0?u.join(", "):"N/A"}if(Array.isArray(i)){const F=i.filter(u=>u&&typeof u=="object"&&"name"in u&&typeof u.name=="string").map(u=>u.name);return F.length>0?F.join(", "):"N/A"}return"N/A"}catch(i){return console.error("Error processing report_to_users:",i),"Error"}})()}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-1",children:[t.observation_type==="direct"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Elephants:"})," ",((m=(a=t.activity_observation)==null?void 0:a[0])==null?void 0:m.total_elephants)||t.total_elephants||0]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Adults:"}),(((s=(h=t.activity_observation)==null?void 0:h[0])==null?void 0:s.adult_male_count)||0)+(((r=(v=t.activity_observation)==null?void 0:v[0])==null?void 0:r.adult_female_count)||0)||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Calves:"})," ",((L=(D=t.activity_observation)==null?void 0:D[0])==null?void 0:L.calf_count)||"N/A"]})]}),t.observation_type==="indirect"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Sign Type:"})," ",t.indirect_sighting_type||((z=(B=t.activity_observation)==null?void 0:B[0])==null?void 0:z.indirect_sighting_type)||"N/A"]}),((P=(M=t.activity_observation)==null?void 0:M[0])==null?void 0:P.damage_done)&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Damage:"})," ",t.activity_observation[0].damage_done]})]}),t.observation_type==="loss"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Damage Type:"}),((H=(I=t.activity_observation)==null?void 0:I[0])==null?void 0:H.damage_done)||(t.damage_done?"Yes":"No")]}),e.jsxs("div",{className:"truncate max-w-xs",children:[e.jsx("span",{className:"font-medium",children:"Details:"}),((U=(q=t.activity_observation)==null?void 0:q[0])==null?void 0:U.damage_description)||t.damage_description||"No details provided"]})]}),(t.compass_bearing||((J=(Y=t.activity_observation)==null?void 0:Y[0])==null?void 0:J.compass_bearing))&&e.jsxs("div",{className:"mt-1",children:[e.jsx("span",{className:"font-medium",children:"Heading:"})," ",t.compass_bearing||((G=(X=t.activity_observation)==null?void 0:X[0])==null?void 0:G.compass_bearing),"Â°"]})]})}),e.jsxs(p,{className:"space-x-2",children:[e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>x(t),title:"Edit",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>ae(t.id),disabled:f,title:"Delete",children:e.jsx(ce,{className:"w-4 h-4 text-red-500"})}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>te(t.id),disabled:f,title:"Sync",children:e.jsx(de,{className:"w-4 h-4"})})]})]},t.id)})})]})}),A>1&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",Math.min((g-1)*N+1,E)," to"," ",Math.min(g*N,E)," of ",E," entries"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(o,{variant:"outline",onClick:()=>O(t=>Math.max(1,t-1)),disabled:g===1||f,children:"Previous"}),e.jsx(o,{variant:"outline",onClick:()=>O(t=>Math.min(A,t+1)),disabled:g>=A||f,children:"Next"})]})]})]})})]}),n&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center",children:e.jsx("div",{className:"bg-white rounded-lg p-4 w-full max-w-md",children:e.jsxs("form",{onSubmit:ie,children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-bold",children:"Edit Observation"}),e.jsx(o,{variant:"ghost",size:"sm",onClick:()=>x(null),title:"Close",children:e.jsx(me,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(S,{htmlFor:"activity_date",children:"Activity Date"}),e.jsx(C,{type:"date",name:"activity_date",value:n.activity_date||"",className:"w-full"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(S,{htmlFor:"total_elephants",children:"Total Elephants"}),e.jsx(C,{type:"number",name:"total_elephants",value:n.total_elephants||0,onChange:t=>x({...n,total_elephants:Number(t.target.value)}),className:"w-full"})]})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(S,{htmlFor:"damage_done",children:"Damage Done"}),e.jsx(C,{type:"checkbox",name:"damage_done",checked:!!n.damage_done,onChange:t=>x({...n,damage_done:t.target.checked}),className:"h-4 w-4"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(S,{htmlFor:"is_offline",children:"Is Offline"}),e.jsx(C,{type:"checkbox",name:"is_offline",checked:!!n.is_offline,onChange:t=>x({...n,is_offline:t.target.checked}),className:"h-4 w-4"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(o,{variant:"outline",onClick:()=>x(null),className:"border-blue-200 hover:bg-blue-50 hover:text-blue-600",children:"Cancel"}),e.jsx(o,{type:"submit",className:"bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-700 hover:to-green-700 text-white shadow-sm",children:"Save Changes"})]})]})})})]})};export{Ae as default};
//# sourceMappingURL=AdminObservations-BWxiE1Go.js.map
