import{j as e,n as ee,r as c,A as x,av as se,L as V,aw as re,ax as ae,ay as te,az as ie,aA as ne}from"./vendor-CnUrRcg9.js";import{c as oe,u as le,a as _,B as N,D as de,e as ce,f as ue,g as me,h as he,i as ge}from"./index-CVoE3lMI.js";import{I as E}from"./input-DrIyNNOV.js";import{L as j}from"./label-QLLoIWWi.js";import{C as xe,a as fe,b as pe,c as be}from"./card-BgkI8bZ8.js";import{S as T,a as F,b as R,c as D,d as g}from"./select-Dpm1cjej.js";import{T as je,a as ve,b as H,c as y,d as we,e as C}from"./table-D1iBvv0q.js";import"./radix-Q9zGz_p4.js";const _e=ee("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function $({className:f,variant:v,...b}){return e.jsx("div",{className:oe(_e({variant:v}),f),...b})}const Ne=(f,v)=>{switch(v.type){case"FETCH_START":return{...f,loading:!0,error:null};case"FETCH_SUCCESS":return{...f,loading:!1,users:v.payload,lastFetched:Date.now()};case"FETCH_ERROR":return{...f,loading:!1,error:v.error};default:return f}};function De(){const[f,v]=c.useState(""),[b,k]=c.useState(!1),[A,X]=c.useState([]),[Z,B]=c.useState([]),[J,q]=c.useState([]),[O,Y]=c.useState(!1),[w,M]=c.useState(null),[z,P]=c.useState(!1),{user:L}=le(),S=c.useRef(null),[h,U]=c.useReducer(Ne,{users:[],loading:!0,error:null,lastFetched:null}),[r,p]=c.useState({email:"",password:"",first_name:"",last_name:"",role:"data_collector",position:"Ranger",division_id:"",range_id:"",beat_id:""});c.useEffect(()=>{if(!b)return;let s=!0;const a=new AbortController,n=setTimeout(async()=>{try{const{data:l,error:i}=await _.from("divisions").select("id, name").order("name").abortSignal(a.signal);if(!s)return;if(i)throw i;l&&X(l)}catch(l){const i=l;i.name!=="AbortError"&&(console.error("Error fetching divisions:",i),x.error("Failed to load divisions"))}},100);return()=>{s=!1,a.abort(),clearTimeout(n)}},[b]),c.useEffect(()=>{let s=!0;if(!(b&&r.division_id&&["Ranger","Guard"].includes(r.position))){s&&(B([]),M(null));return}async function o(){if(s){Y(!0),M(null);try{const{data:l,error:i}=await _.from("ranges").select("new_id, name, new_division_id").eq("new_division_id",r.division_id).order("name");if(!s)return;if(i)throw i;const u=l.map(d=>({id:d.new_id,name:d.name}));B(u)}catch(l){console.error("Error fetching ranges:",l),s&&(M("Failed to load ranges. Please try again."),x.error("Failed to load ranges"))}finally{s&&Y(!1)}}}const n=setTimeout(o,300);return()=>{s=!1,clearTimeout(n)}},[b,r.division_id,r.position]),c.useEffect(()=>{let s=!0;const a=new AbortController;if(!(b&&r.range_id&&r.position==="Guard")){q([]);return}const l=setTimeout(async()=>{try{const{data:i,error:u}=await _.from("beats").select("new_id, name, new_range_id, new_division_id").eq("new_range_id",r.range_id).eq("new_division_id",r.division_id).order("name").abortSignal(a.signal);if(!s)return;if(u)throw u;if(i){const d=i.map(t=>({id:t.new_id,name:t.name}));q(d)}}catch(i){const u=i;u.name!=="AbortError"&&(console.error("Error fetching beats:",u),x.error("Failed to load beats"))}},300);return()=>{s=!1,a.abort(),clearTimeout(l)}},[b,r.range_id,r.position,r.division_id]);const I=c.useCallback(async()=>{var a;S.current&&S.current.abort();const s=new AbortController;if(S.current=s,!(h.lastFetched&&Date.now()-h.lastFetched<3e4)){U({type:"FETCH_START"});try{const o=setTimeout(()=>{s.abort("Request timed out")},1e4),{data:n,error:l}=await _.auth.getSession();if(l||!n.session)throw new Error((l==null?void 0:l.message)||"Not authenticated");const i=await fetch("https://vfsyjvjghftfebvxyjba.supabase.co/functions/v1/get-users",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.session.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmc3lqdmpnaGZ0ZmVidnh5amJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTU3MjYsImV4cCI6MjA2NDYzMTcyNn0.td6SnbD51RuNG_tTuKSC7Jwcz_lUk1tcrcNTwC3OLxc"},body:JSON.stringify({}),signal:s.signal});if(clearTimeout(o),!i.ok){const t=await i.json().catch(()=>({}));throw new Error(((a=t.error)==null?void 0:a.message)||"Failed to fetch users")}const u=await i.json();if(!u.users)throw new Error("Invalid response format from server");const d=u.users.map(t=>({...t,user_region_assignments:t.user_region_assignments||[]}));U({type:"FETCH_SUCCESS",payload:d})}catch(o){if(o.name==="AbortError")return;console.error("Error fetching users:",o);const n=o.message||"Failed to load users";U({type:"FETCH_ERROR",error:n}),x.error(n)}}},[h.lastFetched]);c.useEffect(()=>{I();const s=setInterval(I,5*60*1e3);return()=>{S.current&&S.current.abort(),clearInterval(s)}},[I]);const K=async s=>{var a;if(s.preventDefault(),!r.email||!r.password||!r.first_name||!r.last_name||!r.role||!r.position){x.error("Please fill in all required fields");return}if(["DFO","Ranger","Guard"].includes(r.position)&&!r.division_id){x.error("Please select a division");return}if(["Ranger","Guard"].includes(r.position)&&!r.range_id){x.error("Please select a range");return}if(r.position==="Guard"&&!r.beat_id){x.error("Please select a beat");return}P(!0);try{const o={email:r.email,password:r.password,user_metadata:{first_name:r.first_name,last_name:r.last_name,role:r.role,position:r.position}},n={first_name:r.first_name,last_name:r.last_name,email:r.email,role:r.role,position:r.position,status:"active",created_by:L==null?void 0:L.id};r.position==="DFO"&&r.division_id&&(n.division_id=r.division_id),r.position==="Ranger"&&r.division_id&&r.range_id&&(n.division_id=r.division_id,n.range_id=r.range_id),r.position==="Guard"&&r.division_id&&r.range_id&&r.beat_id&&(n.division_id=r.division_id,n.range_id=r.range_id,n.beat_id=r.beat_id),console.log("Calling create-user function with:",{userData:{...o,password:"[REDACTED]"},assignments:n});const{data:{session:l},error:i}=await _.auth.getSession(),u=l==null?void 0:l.access_token;if(!u||i)throw new Error((i==null?void 0:i.message)||"No active session found. Please log in again.");const d=await fetch("https://vfsyjvjghftfebvxyjba.supabase.co/functions/v1/create-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmc3lqdmpnaGZ0ZmVidnh5amJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTU3MjYsImV4cCI6MjA2NDYzMTcyNn0.td6SnbD51RuNG_tTuKSC7Jwcz_lUk1tcrcNTwC3OLxc"},body:JSON.stringify({userData:o,assignments:n})});console.log("Raw response status:",d.status,d.statusText);let t;try{t=await d.json(),console.log("Response data:",t)}catch{const W=await d.text();throw console.error("Error parsing response. Raw response:",W),new Error("Invalid response from server")}if(!d.ok){console.error("Error response:",t);const m=((a=t==null?void 0:t.error)==null?void 0:a.message)||(t==null?void 0:t.message)||`Request failed with status ${d.status}`;throw new Error(m)}x.success("User created successfully"),P(!1),k(!1),p({email:"",password:"",first_name:"",last_name:"",role:"data_collector",position:"Ranger",division_id:"",range_id:"",beat_id:""}),await I()}catch(o){console.error("Error creating user:",o);const n=o.message||"Failed to create user. Please try again.";x.error(n),P(!1)}finally{setLoading(!1)}},Q=async s=>{if(console.log("handleDeleteUser called with:",s),!s){console.error("No user provided to delete");return}if(!window.confirm(`Are you sure you want to delete ${s.email}?`)){console.log("User cancelled deletion");return}try{console.log("Getting current session...");const{data:{session:a},error:o}=await _.auth.getSession();if(console.log("Session data:",{session:a,sessionError:o}),o)throw console.error("Error getting session:",o),new Error("Failed to verify authentication. Please try again.");if(!a)throw console.error("No active session found"),new Error("No active session. Please log in again.");const n={userId:s.id,authId:s.auth_id||s.id},i="https://vfsyjvjghftfebvxyjba.supabase.co/functions/v1/delete-user";console.log("Calling delete-user function with:",{functionUrl:i,method:"POST",body:n,hasAuthToken:!!(a!=null&&a.access_token)});const u=await fetch(i,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmc3lqdmpnaGZ0ZmVidnh5amJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTU3MjYsImV4cCI6MjA2NDYzMTcyNn0.td6SnbD51RuNG_tTuKSC7Jwcz_lUk1tcrcNTwC3OLxc"}});let d=null,t=null;try{const m=await u.json();u.ok?d=m:t=m.error||{message:"Unknown error occurred"}}catch(m){console.error("Error parsing response:",m),t={message:"Failed to parse server response"}}if(console.log("delete-user function response:",{data:d,error:t}),t){console.error("Error from delete-user function:",{name:t.name,message:t.message,status:t.status,statusText:t.statusText,cause:t.cause});let m=t.message||"Failed to delete user";throw t.status===500?m="Server error while deleting user. Please try again later.":t.status===403?m="You do not have permission to delete users":t.status===401&&(m="Session expired. Please log in again."),new Error(m)}if(!d)throw new Error("No response data from server");console.log("User deleted successfully:",d),U({type:"FETCH_SUCCESS",payload:h.users.filter(m=>m.id!==s.id)}),x.success("User deleted successfully")}catch(a){const o=a instanceof Error?a.message:"Failed to delete user";console.error("Error in handleDeleteUser:",{error:a,message:o,stack:a instanceof Error?a.stack:void 0}),x.error(o)}},G=c.useMemo(()=>{if(!f)return h.users;const s=f.toLowerCase();return h.users.filter(a=>`${a.first_name} ${a.last_name}`.toLowerCase().includes(s)||a.email.toLowerCase().includes(s))},[h.users,f]);return h.loading&&h.users.length===0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"h-10 w-48 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"h-10 w-32 bg-muted rounded animate-pulse"})]}),e.jsx("div",{className:"space-y-2",children:[...Array(5)].map((s,a)=>e.jsx("div",{className:"h-16 bg-muted/50 rounded-lg animate-pulse"},a))})]}):h.error?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-destructive/10 border border-destructive text-destructive p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{className:"w-5 h-5 mr-2"}),e.jsxs("span",{children:["Failed to load users: ",h.error]})]}),e.jsxs(N,{variant:"outline",size:"sm",className:"mt-2",onClick:I,disabled:h.loading,children:[h.loading?e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),"Try Again"]})]})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"rounded-2xl bg-gradient-to-r from-blue-600 to-green-500 px-6 py-6 shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold tracking-tight text-white drop-shadow",children:"User Management"}),e.jsx("p",{className:"text-blue-100 mt-1 text-base",children:"Manage user accounts and permissions"})]}),e.jsxs(N,{onClick:()=>k(!0),className:"bg-white text-blue-700 hover:bg-blue-50 border-blue-200 border font-semibold shadow-sm",children:[e.jsx(ae,{className:"mr-2 h-4 w-4 text-green-600"})," Add User"]})]}),e.jsxs(xe,{className:"bg-gradient-to-br from-blue-50 via-green-50 to-white border-2 border-blue-100/60 shadow-lg",children:[e.jsx(fe,{className:"bg-gradient-to-r from-blue-100/60 to-green-100/60 rounded-t-2xl px-6 py-4 border-b border-green-200/40",children:e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 w-full",children:e.jsxs("div",{className:"w-full",children:[e.jsx(pe,{className:"text-lg mb-1 text-blue-700 font-bold tracking-wide",children:"Users"}),e.jsxs("div",{className:"flex flex-row gap-4 items-center",children:[e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx(te,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-blue-400"}),e.jsx(E,{placeholder:"Search users...",value:f,onChange:s=>v(s.target.value),className:"w-full pl-9 bg-white/70 border border-blue-200 focus:border-green-400"})]}),e.jsxs("span",{className:"ml-2 text-sm text-green-700 font-medium bg-green-100/70 rounded-xl px-3 py-1",children:[G.length," user",G.length!==1?"s":""]})]})]})})}),e.jsx(be,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto rounded-b-2xl",children:e.jsxs(je,{className:"min-w-full divide-y divide-blue-100",children:[e.jsx(ve,{className:"bg-gradient-to-r from-blue-100/40 to-green-100/40",children:e.jsxs(H,{children:[e.jsx(y,{className:"text-blue-700 font-semibold",children:"Name"}),e.jsx(y,{className:"text-blue-700 font-semibold",children:"Email"}),e.jsx(y,{className:"text-green-700 font-semibold",children:"Role"}),e.jsx(y,{className:"text-green-700 font-semibold",children:"Position"}),e.jsx(y,{className:"text-blue-700 font-semibold",children:"Status"}),e.jsx(y,{className:"text-right text-blue-700 font-semibold",children:"Actions"})]})}),e.jsx(we,{children:G.map(s=>e.jsxs(H,{className:"hover:bg-blue-50/60",children:[e.jsxs(C,{className:"font-medium text-blue-900",children:[s.first_name," ",s.last_name]}),e.jsx(C,{className:"text-blue-800",children:s.email}),e.jsx(C,{children:e.jsx($,{variant:"outline",className:"capitalize border-green-300 text-green-700 bg-green-50/80",children:s.role.replace("_"," ")})}),e.jsx(C,{className:"text-green-800",children:s.position}),e.jsx(C,{children:e.jsx($,{variant:s.status==="active"?"default":"destructive",className:s.status==="active"?"bg-green-100 text-green-700 border-green-300":"bg-red-100 text-red-700 border-red-300",children:s.status})}),e.jsx(C,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",className:"h-8 w-8 p-0 border-blue-200 text-blue-700 hover:bg-blue-100/60",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsx(N,{variant:"destructive",size:"sm",className:"h-8 w-8 p-0 border-red-200 text-red-700 hover:bg-red-100/60",onClick:a=>{console.log("Delete button clicked"),a.stopPropagation(),Q(s)},children:e.jsx(ne,{className:"h-4 w-4"})})]})})]},s.id))})]})})})]}),e.jsx(de,{open:b,onOpenChange:k,children:e.jsxs(ce,{className:"sm:max-w-4xl w-[90vw] max-w-[90vw]",children:[e.jsxs(ue,{className:"px-1",children:[e.jsx(me,{className:"text-2xl font-bold text-blue-800",children:"Add New User"}),e.jsx(he,{className:"text-blue-600",children:"Create a new user account with the appropriate permissions and access levels."})]}),e.jsxs("form",{onSubmit:K,children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-8 py-2",children:[e.jsxs("div",{className:"flex-1 bg-gradient-to-br from-blue-50 to-green-50 rounded-xl p-6 shadow-sm border border-blue-100",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-blue-700",children:"Personal Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"first_name",children:"First Name"}),e.jsx(E,{id:"first_name",placeholder:"John",value:r.first_name,onChange:s=>p(a=>({...a,first_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"last_name",children:"Last Name"}),e.jsx(E,{id:"last_name",placeholder:"Doe",value:r.last_name,onChange:s=>p(a=>({...a,last_name:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"email",children:"Email"}),e.jsx(E,{id:"email",type:"email",placeholder:"john.doe@example.com",value:r.email,onChange:s=>p(a=>({...a,email:s.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"password",children:"Password"}),e.jsx(E,{id:"password",type:"password",placeholder:"••••••••",value:r.password,onChange:s=>p(a=>({...a,password:s.target.value})),required:!0,minLength:8}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Password must be at least 8 characters long"})]})]})]}),e.jsxs("div",{className:"flex-1 bg-gradient-to-br from-green-50 to-blue-50 rounded-xl p-6 shadow-sm border border-green-100",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-green-700",children:"Role & Assignment"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"position",children:"Position"}),e.jsxs(T,{value:r.position,onValueChange:s=>p(a=>({...a,position:s})),children:[e.jsx(F,{children:e.jsx(R,{placeholder:"Select position"})}),e.jsxs(D,{children:[e.jsx(g,{value:"DFO",children:"DFO"}),e.jsx(g,{value:"Ranger",children:"Ranger"}),e.jsx(g,{value:"Guard",children:"Guard"}),e.jsx(g,{value:"Officer",children:"Officer"}),e.jsx(g,{value:"Manager",children:"Manager"}),e.jsx(g,{value:"Admin",children:"Admin"})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"role",children:"Role"}),e.jsxs(T,{value:r.role,onValueChange:s=>p(a=>({...a,role:s})),children:[e.jsx(F,{children:e.jsx(R,{placeholder:"Select role"})}),e.jsxs(D,{children:[e.jsx(g,{value:"admin",children:"Admin"}),e.jsx(g,{value:"manager",children:"Manager"}),e.jsx(g,{value:"data_collector",children:"Data Collector"}),e.jsx(g,{value:"viewer",children:"Viewer"})]})]})]}),["DFO","Ranger","Guard"].includes(r.position)&&e.jsxs("div",{children:[e.jsx(j,{children:"Division"}),e.jsxs(T,{value:r.division_id||"",onValueChange:s=>p(a=>({...a,division_id:s})),disabled:A.length===0,children:[e.jsx(F,{children:e.jsx(R,{placeholder:A.length===0?"Loading divisions...":"Select division"})}),e.jsx(D,{children:A.map(s=>e.jsx(g,{value:s.id,children:s.name},s.id))})]})]}),["Ranger","Guard"].includes(r.position)&&r.division_id&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(j,{children:"Range"}),O&&e.jsxs("span",{className:"text-xs text-blue-600 flex items-center",children:[e.jsx(V,{className:"h-3 w-3 mr-1 animate-spin"}),"Loading..."]})]}),e.jsxs(T,{value:r.range_id||"",onValueChange:s=>p(a=>({...a,range_id:s})),disabled:O||w!==null,children:[e.jsx(F,{className:w?"border-red-300":"",children:e.jsx(R,{placeholder:O?"Loading ranges...":w?"Error loading ranges":"Select range"})}),e.jsx(D,{children:w?e.jsx("div",{className:"text-sm text-red-600 p-2",children:w}):Z.length>0?Z.map(s=>e.jsx(g,{value:s.id,children:s.name},s.id)):e.jsx("div",{className:"text-sm text-muted-foreground p-2",children:"No ranges found"})})]}),w&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:w})]}),r.position==="Guard"&&r.range_id&&e.jsxs("div",{children:[e.jsx(j,{children:"Beat"}),e.jsxs(T,{value:r.beat_id||"",onValueChange:s=>p(a=>({...a,beat_id:s})),disabled:J.length===0,children:[e.jsx(F,{children:e.jsx(R,{placeholder:J.length===0?"Loading beats...":"Select beat"})}),e.jsx(D,{children:J.map(s=>e.jsx(g,{value:s.id,children:s.name},s.id))})]})]})]})]})]}),e.jsxs(ge,{className:"gap-2",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>k(!1),disabled:z,children:"Cancel"}),e.jsx(N,{type:"submit",className:"bg-blue-600 hover:bg-blue-700",disabled:z,children:z?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),"Creating..."]}):"Create User"})]})]})]})})]})}export{De as default};
//# sourceMappingURL=AdminUsers-B88ZY8q-.js.map
