import{r as g,j as e,U as he,V as ae,T as K,y as Le,Y as Re,C as I,P as _,Z as fe,G as De,A as m,a0 as Te,a1 as Oe,a2 as $e,a3 as xe,a4 as Ae,a5 as Ue,a6 as ye,a7 as Be,z as ve,a8 as Me,a9 as Ge,aa as re,ab as Ve,ac as ze}from"./vendor-CnUrRcg9.js";import{C as $,c as U,a as qe,b as Je}from"./card-BgkI8bZ8.js";import{s as be,t as He,u as je,v as we,w as We}from"./radix-Q9zGz_p4.js";import{c as X,B as w,s as q,u as Ne,a as Y}from"./index-CVoE3lMI.js";import{I as E}from"./input-DrIyNNOV.js";import{L as j}from"./label-QLLoIWWi.js";import{S as ie,a as ne,b as oe,c as le,d as ce}from"./select-Dpm1cjej.js";import{Device as Ke}from"@capacitor/device";import{Network as J}from"@capacitor/network";const Z=g.forwardRef(({className:s,value:t,...r},a)=>e.jsx(be,{ref:a,className:X("relative h-2 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-800",s),...r,children:e.jsx(He,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})}));Z.displayName=be.displayName;const ue={activity_date:null,activity_time:null,observation_type:null,latitude:null,longitude:null,total_elephants:null,male_elephants:null,female_elephants:null,unknown_elephants:null,calves:null,indirect_sighting_type:null,loss_type:null,compass_bearing:null,photo_url:null},Se=g.createContext(void 0);function Xe({children:s}){const[t,r]=g.useState("dateTimeLocation"),[a,n]=g.useState(ue),[u,i]=g.useState(!1),h=["dateTimeLocation","observationType","compassBearing","photo"],o=()=>{const y=h.indexOf(t);y<h.length-1&&r(h[y+1])},f=()=>{const y=h.indexOf(t);y>0&&r(h[y-1])},N=y=>{n(C=>({...C,...y}))},p=y=>{switch(y){case"dateTimeLocation":return!!a.activity_date&&!!a.activity_time&&a.latitude!==null&&a.longitude!==null;case"observationType":return!!a.observation_type;case"compassBearing":return a.compass_bearing!==null;case"photo":return!0;default:return!1}},S=()=>t===h[h.length-1],b=()=>{n(ue),r("dateTimeLocation"),i(!1)};return e.jsx(Se.Provider,{value:{currentStep:t,formData:a,goToNextStep:o,goToPreviousStep:f,updateFormData:N,isStepValid:p,isLastStep:S,resetForm:b,isPhotoUploading:u,setIsPhotoUploading:i},children:s})}function B(){const s=g.useContext(Se);if(s===void 0)throw new Error("useActivityForm must be used within an ActivityFormProvider");return s}const Ye=()=>{const[s,t]=g.useState({latitude:null,longitude:null,error:null});return g.useEffect(()=>{if(!navigator.geolocation){t(n=>({...n,error:"Geolocation is not supported by your browser"}));return}const r=n=>{t({latitude:n.coords.latitude,longitude:n.coords.longitude,error:null})},a=n=>{t(u=>({...u,error:n.message}))};navigator.geolocation.getCurrentPosition(r,a,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},[]),s};function Ze(){const{formData:s,updateFormData:t}=B(),{latitude:r,longitude:a,error:n}=Ye(),u=()=>{const i=new Date;t({activity_date:i.toISOString().split("T")[0],activity_time:i.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"})}),r&&a&&t({latitude:r,longitude:a})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs(w,{type:"button",variant:"outline",size:"sm",onClick:u,className:"flex items-center gap-2 text-sm",children:[e.jsx(he,{className:"h-4 w-4"}),"Get Location, Date and Time"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{htmlFor:"activity_date",children:"Date"}),e.jsx(ae,{className:"h-4 w-4 text-gray-400"})]}),e.jsx(E,{id:"activity_date",type:"date",value:s.activity_date instanceof Date?s.activity_date.toISOString().split("T")[0]:s.activity_date||"",onChange:i=>t({activity_date:i.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{htmlFor:"activity_time",children:"Time"}),e.jsx(ae,{className:"h-4 w-4 text-gray-400"})]}),e.jsx(E,{id:"activity_time",type:"time",value:s.activity_time||"",onChange:i=>t({activity_time:i.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{children:"Location"}),e.jsx(K,{className:"h-4 w-4 text-gray-400"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"latitude",className:"text-sm text-gray-500",children:"Latitude"}),e.jsx(E,{id:"latitude",type:"number",step:"any",value:s.latitude||"",onChange:i=>t({latitude:parseFloat(i.target.value)}),required:!0})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"longitude",className:"text-sm text-gray-500",children:"Longitude"}),e.jsx(E,{id:"longitude",type:"number",step:"any",value:s.longitude||"",onChange:i=>t({longitude:parseFloat(i.target.value)}),required:!0})]})]}),n&&e.jsxs("p",{className:"text-sm text-red-500 mt-1",children:["Error getting location: ",n]})]})]})]})}const Pe=g.forwardRef(({className:s,...t},r)=>e.jsx(je,{className:X("grid gap-2",s),...t,ref:r}));Pe.displayName=je.displayName;const Ce=g.forwardRef(({className:s,...t},r)=>e.jsx(we,{ref:r,className:X("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(We,{className:"flex items-center justify-center",children:e.jsx(Le,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Ce.displayName=we.displayName;const Qe=[{value:"direct",label:"Direct Sighting"},{value:"indirect",label:"Indirect Sighting"},{value:"loss",label:"Loss Report"}],et=[{value:"Pugmark",label:"Pugmark"},{value:"Dung",label:"Dung"},{value:"Broken Branches",label:"Broken Branches"},{value:"Sound",label:"Sound"},{value:"Eyewitness",label:"Eyewitness"}],tt=[{value:"No loss",label:"No Loss"},{value:"crop",label:"Crop Damage"},{value:"livestock",label:"Livestock Loss"},{value:"property",label:"Property Damage"},{value:"fencing",label:"Fencing Damage"},{value:"solar panels",label:"Solar Panel Damage"},{value:"FD establishment",label:"FD Establishment Damage"},{value:"Other",label:"Other Loss"}],st=()=>{const{formData:s,updateFormData:t}=B(),r=i=>{t({observation_type:i})},a=g.useMemo(()=>Re(i=>{t(i)},300),[t]),n=g.useCallback((i,h)=>{const o=parseInt(h);!isNaN(o)&&o>=0&&a({[i]:o})},[a]),u=g.useCallback((i,h)=>{t({[i]:h})},[t]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{children:e.jsx(U,{className:"pt-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(j,{children:"Type of Observation"}),e.jsx(Pe,{value:s.observation_type,onValueChange:r,className:"mt-2",children:Qe.map(i=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{value:i.value,id:i.value}),e.jsx(j,{htmlFor:i.value,children:i.label})]},i.value))})]}),s.observation_type==="indirect"&&e.jsxs("div",{children:[e.jsx(j,{children:"Indirect Sighting Type"}),e.jsxs(ie,{value:s.indirect_sighting_type||"",onValueChange:i=>u("indirect_sighting_type",i),children:[e.jsx(ne,{className:"w-full bg-white border-gray-200 shadow-sm hover:border-blue-500 transition-colors",children:e.jsx(oe,{placeholder:"Select type of indirect sighting"})}),e.jsx(le,{children:et.map(i=>e.jsx(ce,{value:i.value,children:i.label},i.value))})]})]}),s.observation_type==="loss"&&e.jsxs("div",{children:[e.jsx(j,{children:"Loss Type"}),e.jsxs(ie,{value:s.loss_type||"",onValueChange:i=>u("loss_type",i),children:[e.jsx(ne,{className:"w-full bg-white border-gray-200 shadow-sm hover:border-blue-500 transition-colors",children:e.jsx(oe,{placeholder:"Select type of loss"})}),e.jsx(le,{children:tt.map(i=>e.jsx(ce,{value:i.value,children:i.label},i.value))})]})]})]})})}),s.observation_type==="direct"&&e.jsx($,{children:e.jsx(U,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"total_elephants",children:"Total Elephants"}),e.jsx(E,{type:"number",id:"total_elephants",min:"0",value:s.total_elephants||"",onChange:i=>n("total_elephants",i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"male_elephants",children:"Male Elephants"}),e.jsx(E,{type:"number",id:"male_elephants",min:"0",value:s.male_elephants||"",onChange:i=>n("male_elephants",i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"female_elephants",children:"Female Elephants"}),e.jsx(E,{type:"number",id:"female_elephants",min:"0",value:s.female_elephants||"",onChange:i=>n("female_elephants",i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"unknown_elephants",children:"Unknown Elephants"}),e.jsx(E,{type:"number",id:"unknown_elephants",min:"0",value:s.unknown_elephants||"",onChange:i=>n("unknown_elephants",i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"calves",children:"Calves"}),e.jsx(E,{type:"number",id:"calves",min:"0",value:s.calves||"",onChange:i=>n("calves",i.target.value)})]})]})})})]})},M="app_detailed_logs",de=100;class at{constructor(){this.deviceInfo=null,this.userId=null,this.initDeviceInfo()}async initDeviceInfo(){if(I.isNativePlatform())try{this.deviceInfo=await Ke.getInfo()}catch(t){console.error("Failed to get device info:",t),this.deviceInfo={platform:I.getPlatform(),isVirtual:!1,model:"Unknown"}}else this.deviceInfo={platform:"web",model:navigator.userAgent,osVersion:"unknown",webViewVersion:navigator.appVersion}}setUserId(t){this.userId=t}createLogEntry(t,r,a){return{timestamp:new Date().toISOString(),level:t,message:r,details:a,userId:this.userId||void 0,deviceInfo:this.deviceInfo?{model:this.deviceInfo.model,platform:this.deviceInfo.platform,osVersion:this.deviceInfo.osVersion,appVersion:this.deviceInfo.appVersion||this.deviceInfo.appBuild}:void 0}}async saveLog(t){try{const{value:r}=await _.get({key:M});let a=r?JSON.parse(r):[];a.push(t),a.length>de&&(a=a.slice(-de)),await _.set({key:M,value:JSON.stringify(a)})}catch(r){console.error("Failed to save log:",r)}}debug(t,r){const a=this.createLogEntry("DEBUG",t,r);console.debug(`[DEBUG] ${t}`,r||""),this.saveLog(a)}info(t,r){const a=this.createLogEntry("INFO",t,r);console.info(`[INFO] ${t}`,r||""),this.saveLog(a)}warn(t,r){const a=this.createLogEntry("WARN",t,r);console.warn(`[WARN] ${t}`,r||""),this.saveLog(a)}error(t,r){const a=this.createLogEntry("ERROR",t,r);console.error(`[ERROR] ${t}`,r||""),this.saveLog(a)}async getLogs(){try{const{value:t}=await _.get({key:M});return t?JSON.parse(t):[]}catch(t){return console.error("Failed to get logs:",t),[]}}async clearLogs(){try{await _.remove({key:M})}catch(t){console.error("Failed to clear logs:",t)}}async exportLogs(){const t=await this.getLogs();return JSON.stringify(t,null,2)}}const c=new at,L=[];let V=!1,G=!1,_e=!1,ke=!1;const Q=()=>typeof DeviceOrientationEvent>"u"?(c.warn("DeviceOrientationEvent is not supported on this device"),!1):!0,Ee=async()=>{try{if(!Q())return!1;if(I.getPlatform()==="ios"){const s=DeviceOrientationEvent.requestPermission;if(typeof s=="function")return G=await s()==="granted",c.info(`iOS device orientation permission: ${G?"granted":"denied"}`),G}return G=!0,!0}catch(s){return c.error("Error requesting compass permission:",s),!1}},rt=s=>s,Fe=s=>{if(!s.alpha&&s.alpha!==0){c.warn("Received device orientation event without alpha value");return}const t={alpha:s.alpha,beta:s.beta||0,gamma:s.gamma||0,timestamp:Date.now()};s.absolute||_e?t.trueBearing=s.alpha:ke&&s.webkitCompassHeading&&(t.trueBearing=s.webkitCompassHeading,t.accuracy=s.webkitCompassAccuracy);const r=rt(t);L.forEach(a=>{try{a(r)}catch(n){c.error("Error in compass listener callback:",n)}})},me=async()=>{if(V)return!0;try{if(!Q())return!1;if(!await Ee())return c.warn("Compass permissions denied"),!1;if(ke=typeof window.DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.webkitCompassHeading<"u",_e=typeof DeviceOrientationEvent.absolute<"u",window.addEventListener("deviceorientation",Fe,!0),I.isPluginAvailable("Motion"))try{await fe.addListener("orientation",t=>{const r={alpha:t.alpha,beta:t.beta,gamma:t.gamma,timestamp:Date.now()};L.forEach(a=>{try{a(r)}catch(n){c.error("Error in motion listener callback:",n)}})})}catch(t){c.warn("Error setting up Capacitor Motion:",t)}return V=!0,c.info("Compass initialized successfully"),!0}catch(s){return c.error("Error initializing compass:",s),!1}},it=()=>{V&&(window.removeEventListener("deviceorientation",Fe,!0),I.isPluginAvailable("Motion")&&fe.removeAllListeners(),L.length=0,V=!1)},nt=s=>(L.push(s),L.length-1),ot=s=>{s>=0&&s<L.length&&L.splice(s,1)},lt=(s,t)=>{const r=s.latitude*Math.PI/180,a=s.longitude*Math.PI/180,n=t.latitude*Math.PI/180,u=t.longitude*Math.PI/180,i=Math.sin(u-a)*Math.cos(n),h=Math.cos(r)*Math.sin(n)-Math.sin(r)*Math.cos(n)*Math.cos(u-a);let o=Math.atan2(i,h)*180/Math.PI;return o=(o+360)%360,o},H=async()=>{try{const s={enableHighAccuracy:!0,timeout:1e4};return await De.getCurrentPosition(s)}catch(s){return c.error("Error getting device position:",s),null}},ct=async s=>{try{const t=await H();if(!t)return{bearing:null,currentPosition:null,accuracy:0};const r={latitude:t.coords.latitude,longitude:t.coords.longitude},a=lt(r,s);let n=1;return t.coords.accuracy&&(n=Math.min(1,20/Math.max(t.coords.accuracy,1))),{bearing:a,currentPosition:t,accuracy:n}}catch(t){return c.error("Error calculating bearing to position:",t),{bearing:null,currentPosition:null,accuracy:0}}};function ut(){const{formData:s,updateFormData:t}=B(),[r,a]=g.useState(!1),[n,u]=g.useState(!1),[i,h]=g.useState(!1),[o,f]=g.useState({heading:null,accuracy:0,isGPSBased:!1,isValid:!1,lastUpdated:0,currentPosition:null,targetPosition:null}),N=g.useRef(null),p=g.useRef(null);g.useEffect(()=>(c.info(`Device platform: ${I.getPlatform()}`),(async()=>{try{if(!Q()){m.error("Compass is not available on this device");return}if(await Ee()){c.info("Compass permission granted"),await me(),m.success("Compass initialized successfully");const l=await H();l&&l.coords&&(f(v=>({...v,currentPosition:{latitude:l.coords.latitude,longitude:l.coords.longitude}})),c.info("Initial position acquired",{lat:l.coords.latitude,lng:l.coords.longitude}))}else c.warn("Compass permission denied"),m.error("Compass access denied")}catch(l){c.error("Error initializing compass:",l),m.error("Failed to initialize compass")}})(),()=>{it(),p.current!==null&&navigator.geolocation.clearWatch(p.current)}),[]);const S=d=>{const l=parseInt(d.target.value);!isNaN(l)&&l>=0&&l<=360&&(t({compass_bearing:l}),f(v=>({...v,heading:l,isGPSBased:!1,isValid:!0,lastUpdated:Date.now()})))},b=g.useCallback(async(d,l)=>{if(r)try{const v={latitude:d,longitude:l};f(T=>({...T,targetPosition:v}));const D=await ct(v);if(D.bearing!==null){const T=Math.round(D.bearing);return f(te=>{var se;return{...te,heading:T,accuracy:D.accuracy,isGPSBased:!0,isValid:!0,currentPosition:(se=D.currentPosition)!=null&&se.coords?{latitude:D.currentPosition.coords.latitude,longitude:D.currentPosition.coords.longitude}:te.currentPosition,lastUpdated:Date.now()}}),n||(t({compass_bearing:T}),m.success(`Bearing calculated: ${T}°`)),T}else return m.error("Could not calculate bearing. Please try again"),null}catch(v){return c.error("Error calculating bearing:",v),m.error("Failed to calculate bearing"),null}},[r,n,t]),y=g.useCallback(d=>{if(!r||n)return;let l=0;d.trueBearing!==void 0?l=Math.round(d.trueBearing):l=Math.round((360-d.alpha)%360),N.current=l,c.debug("Compass reading",{heading:l,source:d.source||"device",accuracy:d.accuracy||"unknown",beta:d.beta,gamma:d.gamma}),o.isGPSBased||(f(v=>({...v,heading:l,accuracy:d.accuracy||.7,isGPSBased:!1,isValid:!0,lastUpdated:Date.now()})),n||t({compass_bearing:l}))},[r,n,t,o.isGPSBased]);g.useEffect(()=>{if(r){const d=nt(y);return p.current=navigator.geolocation.watchPosition(l=>{l&&l.coords&&(f(v=>({...v,currentPosition:{latitude:l.coords.latitude,longitude:l.coords.longitude},lastUpdated:Date.now()})),o.targetPosition&&b(o.targetPosition.latitude,o.targetPosition.longitude))},l=>{c.error("GPS Error:",l),m.error(`GPS error: ${l.message}`)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:15e3}),()=>{ot(d),p.current!==null&&navigator.geolocation.clearWatch(p.current)}}return()=>{p.current!==null&&navigator.geolocation.clearWatch(p.current)}},[r,y,b,o.targetPosition]);const C=async()=>{if(r)a(!1),u(!1),m.info("Bearing tracking stopped");else try{if(!await me()){m.error("Could not initialize compass service");return}a(!0),m.success("Bearing tracking started")}catch(d){c.error("Error starting compass tracking:",d),m.error("Failed to start bearing tracking")}},P=()=>{u(!n),n?m.info("Bearing unlocked"):m.info("Bearing locked")},F=async()=>{try{h(!0),m.info("Point your device at the elephant's location and tap 'Set Target'.")}catch(d){c.error("Error setting pointing mode:",d),m.error("Failed to enter pointing mode"),h(!1)}},A=async()=>{const d=await H();if(!d||!d.coords){m.error("Could not get current position. Please try again.");return}const l={latitude:d.coords.latitude,longitude:d.coords.longitude};f(v=>({...v,targetPosition:l})),m.success("Target position set successfully"),h(!1),o.currentPosition&&b(l.latitude,l.longitude)},x=d=>d>.8?"text-green-500":d>.5?"text-amber-500":"text-red-500",k=d=>d>.8?"High":d>.5?"Medium":"Low";return e.jsx("div",{className:"space-y-4",children:e.jsx($,{children:e.jsx(U,{className:"pt-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Compass Bearing"}),e.jsx("div",{className:"flex items-center gap-2",children:r?e.jsxs(e.Fragment,{children:[e.jsxs(w,{variant:"outline",size:"sm",onClick:C,className:"gap-1",children:[e.jsx(Te,{className:"h-4 w-4"}),"Stop"]}),e.jsx(w,{variant:"outline",size:"sm",onClick:P,className:"gap-1",children:n?e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"h-4 w-4"}),"Unlock"]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-4 w-4"}),"Lock"]})})]}):e.jsxs(w,{variant:"default",size:"sm",onClick:C,className:"gap-1",children:[e.jsx(xe,{className:"h-4 w-4"}),"Start Tracking"]})})]}),e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsxs("div",{className:"relative w-48 h-48 rounded-full border-2 border-gray-300 flex items-center justify-center",style:{transform:`rotate(${o.heading||0}deg)`},children:[e.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 bg-primary rounded-full"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Ae,{className:"h-12 w-12 text-primary"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold",children:o.heading!==null?`${o.heading}°`:"--°"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:o.isGPSBased?"GPS-calculated bearing":"Device orientation"})]})]}),r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Target Position"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:o.targetPosition?`${o.targetPosition.latitude.toFixed(6)}, ${o.targetPosition.longitude.toFixed(6)}`:"Not set"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(w,{variant:"outline",onClick:F,className:"flex-1 gap-1",disabled:i,children:[e.jsx(K,{className:"h-4 w-4"}),"Set Target"]}),o.currentPosition&&o.targetPosition&&e.jsxs(w,{onClick:()=>b(o.targetPosition.latitude,o.targetPosition.longitude),className:"flex-1 gap-1",disabled:!o.currentPosition||!o.targetPosition,children:[e.jsx(Ue,{className:"h-4 w-4"}),"Calculate Bearing"]})]}),i&&e.jsxs("div",{className:"mt-2 flex justify-between gap-2",children:[e.jsx(w,{variant:"default",onClick:A,className:"flex-1",children:"Confirm Target"}),e.jsx(w,{variant:"outline",onClick:()=>h(!1),className:"flex-1",children:"Cancel"})]})]}),r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Accuracy"}),e.jsx("span",{className:"font-medium",style:{color:x(o.accuracy)},children:k(o.accuracy)})]}),e.jsx(Z,{value:o.accuracy*100,className:`h-2 bg-${x(o.accuracy).replace("text-","")}`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"compass-bearing",children:"Bearing Value (0-360°)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{id:"compass-bearing",type:"number",min:0,max:360,step:1,value:s.compass_bearing||"",onChange:S,className:"flex-1"}),e.jsxs(w,{variant:"outline",onClick:()=>{r?o.heading!==null&&t({compass_bearing:o.heading}):C()},className:"gap-1",children:[e.jsx(he,{className:"h-4 w-4"}),"Get Current"]})]})]})]}),r&&e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsx("p",{children:"For best results, hold your device flat and point it in the direction of the elephant. The bearing will be calculated automatically."})})]})})})})}const dt=()=>{const{formData:s,updateFormData:t,setIsPhotoUploading:r}=B(),[a,n]=g.useState(!1),u=g.useRef(null),i=async o=>{var N;const f=(N=o.target.files)==null?void 0:N[0];if(f){if(!f.type.startsWith("image/")){m.error("Please select an image file");return}if(f.size>5*1024*1024){m.error("Image size should be less than 5MB");return}console.log("handleFileChange: Starting photo upload process"),n(!0),r(!0),console.log("handleFileChange: isUploadingLocal and isPhotoUploading set to true");try{const p=f.name.split(".").pop(),b=`activity-photos/${`${Math.random()}.${p}`}`,y=q.storage.from("photos").upload(b,f),C=new Promise((A,x)=>{const k=setTimeout(()=>{clearTimeout(k),x(new Error("Photo upload timed out (30 seconds)"))},3e4)}),P=await Promise.race([y,C]);if(P&&typeof P=="object"&&"error"in P&&P.error)throw console.error("handleFileChange: Supabase upload error:",P.error),P.error;if(P instanceof Error)throw console.error("handleFileChange: Timeout error:",P.message),m.error(P.message),P;const{data:{publicUrl:F}}=q.storage.from("photos").getPublicUrl(b);t({photo_url:F}),console.log("handleFileChange: Photo uploaded successfully. Public URL:",F),m.success("Photo uploaded successfully")}catch(p){console.error("handleFileChange: Caught error during photo upload:",p),p instanceof Error&&p.message.includes("timed out")||m.error("Failed to upload photo. Please try again.")}finally{console.log("handleFileChange: Finally block executed. Setting isUploadingLocal and isPhotoUploading to false"),n(!1),r(!1)}}},h=()=>{u.current&&u.current.click()};return e.jsx("div",{className:"space-y-6",children:e.jsx($,{children:e.jsx(U,{className:"pt-6",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(j,{children:"Photo"}),e.jsx("div",{className:"mt-2 flex flex-col items-center justify-center",children:s.photo_url?e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("img",{src:s.photo_url,alt:"Activity photo",className:"w-full h-64 object-cover rounded-lg"}),e.jsx(w,{variant:"destructive",size:"sm",className:"absolute top-2 right-2",onClick:()=>t({photo_url:void 0}),children:"Remove"})]}):e.jsxs("div",{className:"w-full max-w-md h-64 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center",children:[e.jsx(ye,{className:"w-12 h-12 text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"No photo selected"}),e.jsxs(w,{onClick:h,disabled:a,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),a?"Uploading...":"Upload Photo"]}),e.jsx("input",{ref:u,type:"file",accept:"image/*",onChange:i,className:"hidden"})]})})]})})})})})},O=[{type:"dateTimeLocation",title:"Date/Time & Location",icon:e.jsx(K,{className:"w-5 h-5"}),component:Ze},{type:"observationType",title:"Type of Observation",icon:e.jsx(Me,{className:"w-5 h-5"}),component:st},{type:"compassBearing",title:"Compass Bearing",icon:e.jsx(xe,{className:"w-5 h-5"}),component:ut},{type:"photo",title:"Photo",icon:e.jsx(ye,{className:"w-5 h-5"}),component:dt}],mt=s=>s?(s instanceof Date?s:new Date(s)).toISOString().split("T")[0]:"",gt=({onSubmit:s,isSubmitting:t})=>{var A;const{currentStep:r,formData:a,goToNextStep:n,goToPreviousStep:u,isStepValid:i,isLastStep:h,resetForm:o,isPhotoUploading:f}=B(),[N,p]=g.useState(!1),S=ve(),{user:b}=Ne(),y=O.findIndex(x=>x.type===r),C=N||t,P=g.useCallback(async()=>{console.log("handleSubmit: Starting form submission.");try{if(p(!0),console.log("handleSubmit: isSubmitting set to true."),!a.activity_date||!a.activity_time||!a.observation_type){m.error("Please fill in all required fields");return}let x=(b==null?void 0:b.id)||null;if(!x){const{data:{session:v}}=await Y.auth.getSession();v!=null&&v.user&&(x=v.user.id)}const k=mt(a.activity_date),d=a.activity_time||"",l={user_id:x||"",activity_date:new Date(k),activity_time:d,observation_type:a.observation_type,latitude:String(a.latitude||"0"),longitude:String(a.longitude||"0"),total_elephants:a.total_elephants?Number(a.total_elephants):void 0,male_elephants:a.male_elephants?Number(a.male_elephants):void 0,female_elephants:a.female_elephants?Number(a.female_elephants):void 0,unknown_elephants:a.unknown_elephants?Number(a.unknown_elephants):void 0,calves:a.calves?Number(a.calves):void 0,compass_bearing:a.compass_bearing?Number(a.compass_bearing):void 0,photo_url:a.photo_url||void 0,indirect_sighting_type:a.indirect_sighting_type,loss_type:a.loss_type};if(!l.observation_type)throw new Error("Observation type is required");if(!l.latitude||!l.longitude)throw new Error("Location is required");try{await s(l),m.success("Activity report submitted successfully"),o(),S("/")}catch(v){console.error("handleSubmit: Error submitting report:",v),m.error("Failed to submit report")}finally{p(!1),console.log("handleSubmit: Inner try-catch finally block. isSubmitting set to false.")}}catch(x){console.error("Error submitting activity report:",x),m.error(x.message||"Failed to submit report")}finally{p(!1),console.log("handleSubmit: Outer finally block. isSubmitting set to false.")}},[a,S,s,o,b]),F=((A=O.find(x=>x.type===r))==null?void 0:A.component)||null;return e.jsx("div",{className:"container mx-auto p-2 sm:p-4",children:e.jsxs($,{className:"w-full max-w-full sm:max-w-2xl bg-white rounded-xl shadow-sm border border-gray-100 mx-auto",children:[e.jsxs(qe,{className:"space-y-4 sm:space-y-6 p-4 sm:p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[e.jsx(Je,{className:"text-lg sm:text-2xl font-bold text-gray-900",children:"Elephant Watch Report"}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 w-full sm:w-auto",children:[e.jsxs("span",{className:"text-xs sm:text-sm font-medium text-gray-600",children:["Step ",y+1," of ",O.length]}),e.jsx(Z,{value:(y+1)/O.length*100,className:"w-full sm:w-48 h-2 bg-gray-100"})]})]}),e.jsx("div",{className:"flex flex-nowrap overflow-x-auto gap-2 pb-2 sm:pb-0 -mx-2 sm:mx-0 px-2 sm:px-0",children:O.map((x,k)=>e.jsxs(w,{variant:k===y?"default":"outline",size:"sm",className:`flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md transition-colors whitespace-nowrap text-xs sm:text-sm
                  ${k===y?"bg-blue-600 hover:bg-blue-700 text-white border-blue-600":"bg-white hover:bg-gray-50 text-gray-600 border-gray-200"}`,disabled:k>y&&!i(O[k-1].type),children:[x.icon,x.title]},x.type))})]}),e.jsxs(U,{className:"p-4 sm:p-6",children:[F&&e.jsx(F,{}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-100 gap-2 sm:gap-0",children:[e.jsx(w,{variant:"outline",onClick:u,disabled:y===0||C,className:"border-gray-200 text-gray-600 hover:bg-gray-50 w-full sm:w-auto",children:"Previous"}),h()?e.jsx(w,{onClick:P,disabled:(()=>{const x=!i(r)||C||f;return console.log(`Submit button disabled check: isStepValid(${r})=${i(r)}, isActuallySubmitting=${C}, isPhotoUploading=${f}. Result: ${x}`),x})(),className:"bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto",children:f?"Uploading Photo...":C?"Submitting...":"Submit Report"}):e.jsx(w,{onClick:n,disabled:!i(r)||C||f,className:"bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto",children:"Next"})]})]})]})})},pt=s=>e.jsx(Xe,{children:e.jsx(e.Fragment,{children:e.jsx(gt,{...s})})});let W={connected:!0};const ht=async()=>{try{const s=await J.getStatus();return W=s,console.log("Initial network status:",s),J.addListener("networkStatusChange",t=>{console.log("Network status changed:",t),W=t}),s}catch(s){return console.error("Error initializing network monitoring:",s),{connected:!0}}},ee=async()=>{try{return I.isNativePlatform()?(await J.getStatus()).connected:window.navigator.onLine}catch(s){return console.error("Error checking network status:",s),W.connected}},Ie=async s=>{if(c.info(`ensureUserExists called for userId: ${s}`),!s)return c.error("Cannot ensure user exists with empty userId"),null;try{c.debug(`Checking if user ${s} already exists in public.users table`);const{data:t,error:r}=await q.from("users").select("id").eq("auth_id",s).single();return r?r.code==="PGRST116"?(c.warn(`User ${s} not found in public.users table. Not attempting to create as per instruction.`),null):(c.error(`Error checking if user ${s} exists:`,r),null):t?(c.debug(`User ${s} already exists in public.users table. Returning ID: ${t.id}`),t.id):(c.warn(`Unexpected state: User ${s} not found, but no PGRST116 error. Not attempting to create.`),null)}catch(t){return c.error("Unexpected error in ensureUserExists:",t),null}},R="pendingActivityReports",z=async s=>{try{console.log("Saving report for later sync:",s);const t={id:Ge(),reportData:s,createdAt:new Date().toISOString(),syncAttempts:0},{value:r}=await _.get({key:R}),n=[...r?JSON.parse(r):[],t];return await _.set({key:R,value:JSON.stringify(n)}),console.log(`Report saved for later sync. Total pending reports: ${n.length}`),t}catch(t){throw console.error("Error saving report for later:",t),t}},ge=async()=>{try{const{value:s}=await _.get({key:R});return s?JSON.parse(s):[]}catch(s){return console.error("Error getting pending reports:",s),[]}},ft=async s=>{try{const{value:t}=await _.get({key:R});if(!t)return;const a=JSON.parse(t).filter(n=>n.id!==s);await _.set({key:R,value:JSON.stringify(a)}),console.log(`Removed synced report ${s}. Remaining: ${a.length}`)}catch(t){console.error("Error removing pending report:",t)}},xt=async s=>{try{const{value:t}=await _.get({key:R});if(!t)return;const a=JSON.parse(t).map(n=>n.id===s?{...n,syncAttempts:n.syncAttempts+1,lastSyncAttempt:new Date().toISOString()}:n);await _.set({key:R,value:JSON.stringify(a)})}catch(t){console.error("Error updating sync attempt:",t)}},pe=async()=>{if(!await ee())return c.info("Device is offline, skipping sync attempt"),{success:0,failed:0,remaining:0};try{const t=await ge();if(t.length===0)return{success:0,failed:0,remaining:0};c.info(`Attempting to sync ${t.length} pending reports`);let r=0,a=0;for(const u of t)try{await xt(u.id);const i=u.reportData.user_id;if(!i){c.error(`Report ${u.id} has no user_id, skipping sync`),a++;continue}const h=await Ie(i);if(!h){c.error(`Failed to ensure user ${i} exists, skipping sync for report ${u.id}`),a++;continue}u.reportData.user_id=h;const{error:o}=await Y.from("activity_reports").insert([u.reportData]);o?(c.error(`Error syncing report ${u.id}:`,o),a++):(await ft(u.id),r++,c.info(`Successfully synced report ${u.id}`))}catch(i){console.error(`Error processing report ${u.id}:`,i),a++}const n=await ge();return console.log(`Sync complete. Success: ${r}, Failed: ${a}, Remaining: ${n.length}`),{success:r,failed:a,remaining:n.length}}catch(t){return console.error("Error syncing pending reports:",t),{success:0,failed:0,remaining:0}}},yt=async s=>{try{if(!await ee())return await z(s),{success:!0,offline:!0,message:"Report saved locally and will be submitted when online"};if(!s.user_id)throw new Error("User ID is required for activity report");c.debug(`Attempting to ensure user exists for auth_id: ${s.user_id}`);const r=await Ie(s.user_id);if(!r)throw new Error(`Failed to ensure user ${s.user_id} exists in database`);s.user_id=r;const{error:a}=await Y.from("activity_reports").insert([s]);return a?(await z(s),{success:!1,offline:!1,message:`Failed to submit report: ${a.message}`,error:a}):{success:!0,offline:!1,message:"Report submitted successfully"}}catch(t){return await z(s),{success:!1,offline:!1,message:`Error during submission: ${t.message||"Unknown error"}`,error:t}}},kt=()=>{const[s,t]=g.useState(!1),[r,a]=g.useState(null),[n,u]=g.useState(0),{user:i,loading:h}=Ne(),o=ve();if(g.useEffect(()=>{!h&&!i&&o("/login")},[i,h,o]),g.useEffect(()=>{(async()=>{const S=await ht();a(S.connected),pe().then(b=>{u(b.remaining),b.success>0&&m.success(`Successfully synced ${b.success} pending reports`)})})();const p=setInterval(async()=>{const S=await ee();if(a(S),S){const b=await pe();u(b.remaining)}},3e4);return()=>clearInterval(p)},[]),h)return e.jsx("div",{className:"flex items-center justify-center h-screen",children:"Loading..."});if(!i)return null;const f=async N=>{t(!0);try{c.info("Submitting activity report",{type:N.observation_type,location:`${N.latitude},${N.longitude}`});const p=await yt(N);p.success?(p.offline?(m.success("Report saved locally and will be submitted when online"),u(S=>S+1)):m.success("Activity report submitted successfully"),o("/activities")):(c.error("Error submitting report",p.error),m.error(p.message))}catch(p){c.error("Unexpected error submitting report:",p),m.error(`Failed to submit report: ${p instanceof Error?p.message:"Unknown error"}`)}finally{t(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"container mx-auto p-2 sm:p-4",children:[e.jsxs("header",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl",children:"Wild Elephant Monitoring System"}),e.jsx("h2",{className:"mt-2 text-2xl font-semibold text-gray-600",children:"जंगली हाथी निगरानी प्रणाली (2025)"}),e.jsx("div",{className:"mt-2 flex items-center",children:r===null?e.jsxs("span",{className:"inline-flex items-center text-gray-500",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"text-sm",children:"Checking network status..."})]}):r?e.jsxs("span",{className:"inline-flex items-center text-green-600",children:[e.jsx(Ve,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"text-sm",children:"Online Mode"})]}):e.jsxs("span",{className:"inline-flex items-center text-amber-600",children:[e.jsx(ze,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"text-sm",children:"Offline Mode"}),n>0&&e.jsxs("span",{className:"ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800",children:[n," pending"]})]})})]}),e.jsx($,{className:"mb-8 overflow-hidden border border-blue-100 bg-white shadow-sm",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(re,{className:"h-6 w-6 text-blue-600 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"निर्देश / Instructions:"}),e.jsxs("ul",{className:"space-y-3 text-gray-600",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["इस फॉर्म को चार चरणों में पूरा करें: तारीख/समय और स्थान, अवलोकन का प्रकार, कम्पास बेयरिंग, और फोटो।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Complete this form in four steps: Date/Time & Location, Type of Observation, Compass Bearing, and Photo."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["प्रत्येक चरण में आवश्यक जानकारी भरें और 'Next' बटन पर क्लिक करें। पिछले चरण पर जाने के लिए 'Previous' बटन का उपयोग करें।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Fill in the required information in each step and click 'Next'. Use 'Previous' to go back to earlier steps."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["GPS लोकेशन को Degree Decimal फॉर्मेट में भरें (उदाहरण: 23.4536 81.4763)। सटीक स्थान महत्वपूर्ण है।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Enter GPS location in Degree Decimal format (Example: 23.4536 81.4763). Accurate location is crucial."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["अवलोकन के प्रकार के अनुसार, हाथियों की संख्या या अप्रत्यक्ष साक्ष्य का विवरण दें।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Based on observation type, provide elephant count or indirect evidence details."})]})]})]})]})]})})}),e.jsx("main",{className:"max-w-4xl mx-auto",children:e.jsx(pt,{onSubmit:f,isSubmitting:s})})]})})};export{kt as default};
//# sourceMappingURL=ReportActivityPage-B8ifQnp8.js.map
