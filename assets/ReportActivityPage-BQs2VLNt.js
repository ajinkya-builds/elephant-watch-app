import{j as e,u as Q}from"./ui-DUKcQzV-.js";import{a as n,g as st,i as ve,R as at}from"./vendor-C4vCQKbn.js";import{C as G,c as $,a as rt,b as ot}from"./card-CypzqOhv.js";import{c as A,a as Z,P as U,b as ee,B as P,d as be,e as it,f as nt,R as lt,I as ct,g as X,h as dt,i as ut,C as mt,j as v,s as Y,u as ye,k as pt}from"./index-D06kCfwG.js";import{I as E}from"./input-PBczrgJI.js";import{L as N}from"./label-Dr6kIi7P.js";import{R as je}from"./refresh-cw-CdRCDSUe.js";import{M as Ne}from"./map-pin-CIKOhl-H.js";import{u as ht}from"./index-BozIbYBo.js";import{S as ne,a as le,b as ce,c as de,d as ue}from"./select-rBkzWHzS.js";import{r as gt}from"./charts-BMxcv32P.js";import{T as xt,a as ft,b as K}from"./tabs-uO-I0-BS.js";import{C as we}from"./circle-alert-C7QHohYY.js";import{F as vt}from"./file-text-D4d21xS7.js";import"./supabase-BA4zP0Ex.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=A("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=A("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=A("Compass",[["path",{d:"m16.24 7.76-1.804 5.411a2 2 0 0 1-1.265 1.265L7.76 16.24l1.804-5.411a2 2 0 0 1 1.265-1.265z",key:"9ktpf1"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=A("LockOpen",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=A("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=A("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=A("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);var se="Progress",ae=100,[Nt,gs]=Z(se),[wt,St]=Nt(se),Se=n.forwardRef((t,o)=>{const{__scopeProgress:i,value:r=null,max:a,getValueLabel:d=Ct,...s}=t;(a||a===0)&&!he(a)&&console.error(_t(`${a}`,"Progress"));const l=he(a)?a:ae;r!==null&&!ge(r,l)&&console.error(Pt(`${r}`,"Progress"));const m=ge(r,l)?r:null,x=V(m)?d(m,l):void 0;return e.jsx(wt,{scope:i,value:m,max:l,children:e.jsx(U.div,{"aria-valuemax":l,"aria-valuemin":0,"aria-valuenow":V(m)?m:void 0,"aria-valuetext":x,role:"progressbar","data-state":Pe(m,l),"data-value":m??void 0,"data-max":l,...s,ref:o})})});Se.displayName=se;var Ce="ProgressIndicator",_e=n.forwardRef((t,o)=>{const{__scopeProgress:i,...r}=t,a=St(Ce,i);return e.jsx(U.div,{"data-state":Pe(a.value,a.max),"data-value":a.value??void 0,"data-max":a.max,...r,ref:o})});_e.displayName=Ce;function Ct(t,o){return`${Math.round(t/o*100)}%`}function Pe(t,o){return t==null?"indeterminate":t===o?"complete":"loading"}function V(t){return typeof t=="number"}function he(t){return V(t)&&!isNaN(t)&&t>0}function ge(t,o){return V(t)&&!isNaN(t)&&t<=o&&t>=0}function _t(t,o){return`Invalid prop \`max\` of value \`${t}\` supplied to \`${o}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${ae}\`.`}function Pt(t,o){return`Invalid prop \`value\` of value \`${t}\` supplied to \`${o}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${ae} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var ke=Se,kt=_e;const re=n.forwardRef(({className:t,value:o,...i},r)=>e.jsx(ke,{ref:r,className:ee("relative h-2 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-800",t),...i,children:e.jsx(kt,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(o||0)}%)`}})}));re.displayName=ke.displayName;const xe={activity_date:null,activity_time:null,observation_type:null,latitude:null,longitude:null,total_elephants:null,male_elephants:null,female_elephants:null,unknown_elephants:null,calves:null,indirect_sighting_type:null,loss_type:null,compass_bearing:null,photo_url:null},Re=n.createContext(void 0);function Rt({children:t}){const[o,i]=n.useState("dateTimeLocation"),[r,a]=n.useState(xe),[d,s]=n.useState(!1),l=["dateTimeLocation","observationType","compassBearing","photo"],m=()=>{const u=l.indexOf(o);u<l.length-1&&i(l[u+1])},x=()=>{const u=l.indexOf(o);u>0&&i(l[u-1])},b=u=>{a(y=>({...y,...u}))},g=u=>{switch(u){case"dateTimeLocation":return!!r.activity_date&&!!r.activity_time&&r.latitude!==null&&r.longitude!==null;case"observationType":return!!r.observation_type;case"compassBearing":return r.compass_bearing!==null;case"photo":return!0;default:return!1}},w=()=>o===l[l.length-1],h=()=>{a(xe),i("dateTimeLocation"),s(!1)};return e.jsx(Re.Provider,{value:{currentStep:o,formData:r,goToNextStep:m,goToPreviousStep:x,updateFormData:b,isStepValid:g,isLastStep:w,resetForm:h,isPhotoUploading:d,setIsPhotoUploading:s},children:t})}function B(){const t=n.useContext(Re);if(t===void 0)throw new Error("useActivityForm must be used within an ActivityFormProvider");return t}const Et=()=>{const[t,o]=n.useState({latitude:null,longitude:null,error:null});return n.useEffect(()=>{if(!navigator.geolocation){o(a=>({...a,error:"Geolocation is not supported by your browser"}));return}const i=a=>{o({latitude:a.coords.latitude,longitude:a.coords.longitude,error:null})},r=a=>{o(d=>({...d,error:a.message}))};navigator.geolocation.getCurrentPosition(i,r,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})},[]),t};function It(){const{formData:t,updateFormData:o}=B(),{latitude:i,longitude:r,error:a}=Et(),d=()=>{const s=new Date;o({activity_date:s.toISOString().split("T")[0],activity_time:s.toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit"})}),i&&r&&o({latitude:i,longitude:r})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:d,className:"flex items-center gap-2 text-sm",children:[e.jsx(je,{className:"h-4 w-4"}),"Get Location, Date and Time"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{htmlFor:"activity_date",children:"Date"}),e.jsx(me,{className:"h-4 w-4 text-gray-400"})]}),e.jsx(E,{id:"activity_date",type:"date",value:t.activity_date instanceof Date?t.activity_date.toISOString().split("T")[0]:t.activity_date||"",onChange:s=>o({activity_date:s.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{htmlFor:"activity_time",children:"Time"}),e.jsx(me,{className:"h-4 w-4 text-gray-400"})]}),e.jsx(E,{id:"activity_time",type:"time",value:t.activity_time||"",onChange:s=>o({activity_time:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{children:"Location"}),e.jsx(Ne,{className:"h-4 w-4 text-gray-400"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"latitude",className:"text-sm text-gray-500",children:"Latitude"}),e.jsx(E,{id:"latitude",type:"number",step:"any",value:t.latitude||"",onChange:s=>o({latitude:parseFloat(s.target.value)}),required:!0})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"longitude",className:"text-sm text-gray-500",children:"Longitude"}),e.jsx(E,{id:"longitude",type:"number",step:"any",value:t.longitude||"",onChange:s=>o({longitude:parseFloat(s.target.value)}),required:!0})]})]}),a&&e.jsxs("p",{className:"text-sm text-red-500 mt-1",children:["Error getting location: ",a]})]})]})]})}var oe="Radio",[Dt,Ee]=Z(oe),[Ft,Tt]=Dt(oe),Ie=n.forwardRef((t,o)=>{const{__scopeRadio:i,name:r,checked:a=!1,required:d,disabled:s,value:l="on",onCheck:m,form:x,...b}=t,[g,w]=n.useState(null),h=Q(o,p=>w(p)),u=n.useRef(!1),y=g?x||!!g.closest("form"):!0;return e.jsxs(Ft,{scope:i,checked:a,disabled:s,children:[e.jsx(U.button,{type:"button",role:"radio","aria-checked":a,"data-state":Le(a),"data-disabled":s?"":void 0,disabled:s,value:l,...b,ref:h,onClick:X(t.onClick,p=>{a||m==null||m(),y&&(u.current=p.isPropagationStopped(),u.current||p.stopPropagation())})}),y&&e.jsx(Te,{control:g,bubbles:!u.current,name:r,value:l,checked:a,required:d,disabled:s,form:x,style:{transform:"translateX(-100%)"}})]})});Ie.displayName=oe;var De="RadioIndicator",Fe=n.forwardRef((t,o)=>{const{__scopeRadio:i,forceMount:r,...a}=t,d=Tt(De,i);return e.jsx(dt,{present:r||d.checked,children:e.jsx(U.span,{"data-state":Le(d.checked),"data-disabled":d.disabled?"":void 0,...a,ref:o})})});Fe.displayName=De;var Lt="RadioBubbleInput",Te=n.forwardRef(({__scopeRadio:t,control:o,checked:i,bubbles:r=!0,...a},d)=>{const s=n.useRef(null),l=Q(s,d),m=ht(i),x=ut(o);return n.useEffect(()=>{const b=s.current;if(!b)return;const g=window.HTMLInputElement.prototype,h=Object.getOwnPropertyDescriptor(g,"checked").set;if(m!==i&&h){const u=new Event("click",{bubbles:r});h.call(b,i),b.dispatchEvent(u)}},[m,i,r]),e.jsx(U.input,{type:"radio","aria-hidden":!0,defaultChecked:i,...a,tabIndex:-1,ref:l,style:{...a.style,...x,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Te.displayName=Lt;function Le(t){return t?"checked":"unchecked"}var At=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],H="RadioGroup",[Ot,xs]=Z(H,[be,Ee]),Ae=be(),Oe=Ee(),[Mt,Gt]=Ot(H),Me=n.forwardRef((t,o)=>{const{__scopeRadioGroup:i,name:r,defaultValue:a,value:d,required:s=!1,disabled:l=!1,orientation:m,dir:x,loop:b=!0,onValueChange:g,...w}=t,h=Ae(i),u=it(x),[y,p]=nt({prop:d,defaultProp:a??null,onChange:g,caller:H});return e.jsx(Mt,{scope:i,name:r,required:s,disabled:l,value:y,onValueChange:p,children:e.jsx(lt,{asChild:!0,...h,orientation:m,dir:u,loop:b,children:e.jsx(U.div,{role:"radiogroup","aria-required":s,"aria-orientation":m,"data-disabled":l?"":void 0,dir:u,...w,ref:o})})})});Me.displayName=H;var Ge="RadioGroupItem",Ue=n.forwardRef((t,o)=>{const{__scopeRadioGroup:i,disabled:r,...a}=t,d=Gt(Ge,i),s=d.disabled||r,l=Ae(i),m=Oe(i),x=n.useRef(null),b=Q(o,x),g=d.value===a.value,w=n.useRef(!1);return n.useEffect(()=>{const h=y=>{At.includes(y.key)&&(w.current=!0)},u=()=>w.current=!1;return document.addEventListener("keydown",h),document.addEventListener("keyup",u),()=>{document.removeEventListener("keydown",h),document.removeEventListener("keyup",u)}},[]),e.jsx(ct,{asChild:!0,...l,focusable:!s,active:g,children:e.jsx(Ie,{disabled:s,required:d.required,checked:g,...m,...a,name:d.name,ref:b,onCheck:()=>d.onValueChange(a.value),onKeyDown:X(h=>{h.key==="Enter"&&h.preventDefault()}),onFocus:X(a.onFocus,()=>{var h;w.current&&((h=x.current)==null||h.click())})})})});Ue.displayName=Ge;var Ut="RadioGroupIndicator",$e=n.forwardRef((t,o)=>{const{__scopeRadioGroup:i,...r}=t,a=Oe(i);return e.jsx(Fe,{...a,...r,ref:o})});$e.displayName=Ut;var Be=Me,Ve=Ue,$t=$e;const He=n.forwardRef(({className:t,...o},i)=>e.jsx(Be,{className:ee("grid gap-2",t),...o,ref:i}));He.displayName=Be.displayName;const qe=n.forwardRef(({className:t,...o},i)=>e.jsx(Ve,{ref:i,className:ee("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...o,children:e.jsx($t,{className:"flex items-center justify-center",children:e.jsx(mt,{className:"h-2.5 w-2.5 fill-current text-current"})})}));qe.displayName=Ve.displayName;var Bt=gt();const Vt=st(Bt),Ht=[{value:"direct",label:"Direct Sighting"},{value:"indirect",label:"Indirect Sighting"},{value:"loss",label:"Loss Report"}],qt=[{value:"Pugmark",label:"Pugmark"},{value:"Dung",label:"Dung"},{value:"Broken Branches",label:"Broken Branches"},{value:"Sound",label:"Sound"},{value:"Eyewitness",label:"Eyewitness"}],zt=[{value:"No loss",label:"No Loss"},{value:"crop",label:"Crop Damage"},{value:"livestock",label:"Livestock Loss"},{value:"property",label:"Property Damage"},{value:"fencing",label:"Fencing Damage"},{value:"solar panels",label:"Solar Panel Damage"},{value:"FD establishment",label:"FD Establishment Damage"},{value:"Other",label:"Other Loss"}],Wt=()=>{const{formData:t,updateFormData:o}=B(),i=s=>{o({observation_type:s})},r=n.useMemo(()=>Vt(s=>{o(s)},300),[o]),a=n.useCallback((s,l)=>{const m=parseInt(l);!isNaN(m)&&m>=0&&r({[s]:m})},[r]),d=n.useCallback((s,l)=>{o({[s]:l})},[o]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(G,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"Type of Observation"}),e.jsx(He,{value:t.observation_type,onValueChange:i,className:"mt-2",children:Ht.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{value:s.value,id:s.value}),e.jsx(N,{htmlFor:s.value,children:s.label})]},s.value))})]}),t.observation_type==="indirect"&&e.jsxs("div",{children:[e.jsx(N,{children:"Indirect Sighting Type"}),e.jsxs(ne,{value:t.indirect_sighting_type||"",onValueChange:s=>d("indirect_sighting_type",s),children:[e.jsx(le,{className:"w-full bg-white border-gray-200 shadow-sm hover:border-blue-500 transition-colors",children:e.jsx(ce,{placeholder:"Select type of indirect sighting"})}),e.jsx(de,{children:qt.map(s=>e.jsx(ue,{value:s.value,children:s.label},s.value))})]})]}),t.observation_type==="loss"&&e.jsxs("div",{children:[e.jsx(N,{children:"Loss Type"}),e.jsxs(ne,{value:t.loss_type||"",onValueChange:s=>d("loss_type",s),children:[e.jsx(le,{className:"w-full bg-white border-gray-200 shadow-sm hover:border-blue-500 transition-colors",children:e.jsx(ce,{placeholder:"Select type of loss"})}),e.jsx(de,{children:zt.map(s=>e.jsx(ue,{value:s.value,children:s.label},s.value))})]})]})]})})}),t.observation_type==="direct"&&e.jsx(G,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"total_elephants",children:"Total Elephants"}),e.jsx(E,{type:"number",id:"total_elephants",min:"0",value:t.total_elephants||"",onChange:s=>a("total_elephants",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"male_elephants",children:"Male Elephants"}),e.jsx(E,{type:"number",id:"male_elephants",min:"0",value:t.male_elephants||"",onChange:s=>a("male_elephants",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"female_elephants",children:"Female Elephants"}),e.jsx(E,{type:"number",id:"female_elephants",min:"0",value:t.female_elephants||"",onChange:s=>a("female_elephants",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"unknown_elephants",children:"Unknown Elephants"}),e.jsx(E,{type:"number",id:"unknown_elephants",min:"0",value:t.unknown_elephants||"",onChange:s=>a("unknown_elephants",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"calves",children:"Calves"}),e.jsx(E,{type:"number",id:"calves",min:"0",value:t.calves||"",onChange:s=>a("calves",s.target.value)})]})]})})})]})},fe=1,Kt=10;function Xt(){const{formData:t,updateFormData:o}=B(),[i,r]=n.useState(!1),[a,d]=n.useState(!1),[s,l]=n.useState(!1),[m,x]=n.useState([]),[b,g]=n.useState(0),[w,h]=n.useState(null),[u,y]=n.useState(!1),[p,F]=n.useState("gps"),[_,f]=n.useState({heading:0,accuracy:0,isGPSBased:!1,isErratic:!1,speed:0}),S=n.useRef([]),O=n.useRef(null),k=n.useRef(null),C=n.useRef(null),T=n.useRef(null),q=n.useRef(null);n.useEffect(()=>{const c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;y(c);const j=localStorage.getItem("compassCalibrationOffset");j&&g(parseFloat(j));const R=localStorage.getItem("compassMode");return R&&F(R),window.DeviceOrientationEvent?h(!c):(v.error("Device orientation is not supported on this device"),h(!1)),()=>{C.current!==null&&navigator.geolocation.clearWatch(C.current),T.current&&T.current.srcObject&&T.current.srcObject.getTracks().forEach(L=>L.stop())}},[]);const ze=c=>{const j=parseInt(c.target.value);!isNaN(j)&&j>=0&&j<=360&&o({compass_bearing:j})},We=()=>{p==="visual"?Ye():Ke()},Ke=()=>{l(!0),v.info("Point your device north and tap 'Set North' when ready")},Xe=()=>{if(k.current!==null){const c=(360-k.current)%360;g(c),localStorage.setItem("compassCalibrationOffset",c.toString()),l(!1),v.success("North direction set successfully")}},Ye=async()=>{try{const c=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});T.current&&(T.current.srcObject=c,l(!0),v.info("Align the camera with a known landmark and tap 'Set Direction'"))}catch(c){console.error("Error accessing camera:",c),v.error("Failed to access camera")}},Je=()=>{if(q.current&&T.current){const c=q.current,j=T.current,R=c.getContext("2d");if(R){R.drawImage(j,0,0,c.width,c.height),R.getImageData(0,0,c.width,c.height);const I=0;g(I),localStorage.setItem("compassCalibrationOffset",I.toString()),l(!1),v.success("Direction set from visual reference")}}},ie=n.useCallback(c=>{if(!i||a||!O.current){O.current=c;return}const{speed:j,accuracy:R}=c.coords,I=O.current.coords,L=c.coords;if(f(D=>({...D,speed:j||0,accuracy:R<=Kt?1:.5})),j&&j>fe){const D=Math.round((Math.atan2(L.longitude-I.longitude,L.latitude-I.latitude)*180/Math.PI+360)%360);f(W=>({...W,heading:D,isGPSBased:!0,isErratic:!1})),a||o({compass_bearing:D})}else if(p==="manual"&&k.current!==null){const D=(k.current+b)%360;f(W=>({...W,heading:D,isGPSBased:!1,isErratic:!1})),a||o({compass_bearing:D})}O.current=c},[i,a,o,p,b]),z=n.useCallback(c=>{if(!i||a)return;let j=0;if(u&&c.webkitCompassHeading?j=c.webkitCompassHeading:c.alpha!==null&&(j=Math.round((360-c.alpha)%360)),k.current=j,p==="manual"&&_.speed<=fe){const R=(j+b)%360;S.current=[...S.current.slice(-4),R];const I=Math.round(S.current.reduce((L,D)=>L+D,0)/S.current.length);f(L=>({...L,heading:I,accuracy:.8,isGPSBased:!1,isErratic:!1})),a||o({compass_bearing:I})}},[i,a,b,o,p,_.speed]);n.useEffect(()=>(i&&(C.current=navigator.geolocation.watchPosition(ie,c=>console.error("GPS Error:",c),{enableHighAccuracy:!0}),p==="manual"&&window.addEventListener("deviceorientation",z)),()=>{C.current!==null&&navigator.geolocation.clearWatch(C.current),window.removeEventListener("deviceorientation",z)}),[i,ie,z,p]);const Qe=()=>{r(!i),i?v.info("Compass tracking stopped"):v.info("Compass tracking started")},Ze=()=>{d(!a),a?v.info("Compass bearing unlocked"):v.info("Compass bearing locked")},et=c=>{F(c),localStorage.setItem("compassMode",c),v.info(`Switched to ${c} mode`)},tt=c=>c>=.8?"bg-green-500":c>=.5?"bg-yellow-500":"bg-red-500";return e.jsx("div",{className:"space-y-6",children:e.jsx(G,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsx(xt,{defaultValue:p,onValueChange:c=>et(c),children:e.jsxs(ft,{children:[e.jsxs(K,{value:"gps",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"GPS"]}),e.jsxs(K,{value:"manual",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Manual"]}),e.jsxs(K,{value:"visual",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Visual"]})]})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(P,{variant:i?"destructive":"default",onClick:Qe,className:"flex items-center space-x-2",children:[e.jsx(J,{className:`w-4 h-4 ${i?"animate-spin":""}`}),e.jsx("span",{children:i?"Stop Tracking":"Start Tracking"})]}),e.jsxs(P,{variant:a?"default":"outline",onClick:Ze,className:"flex items-center space-x-2",disabled:!i,children:[a?e.jsx(yt,{className:"w-4 h-4"}):e.jsx(bt,{className:"w-4 h-4"}),e.jsx("span",{children:a?"Unlock":"Lock"})]}),s?e.jsxs(P,{variant:"default",onClick:p==="visual"?Je:Xe,className:"flex items-center space-x-2",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{children:["Set ",p==="visual"?"Direction":"North"]})]}):e.jsxs(P,{variant:"outline",onClick:We,className:"flex items-center space-x-2",disabled:!i,children:[e.jsx(je,{className:`w-4 h-4 ${s?"animate-spin":""}`}),e.jsx("span",{children:"Calibrate"})]})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(N,{htmlFor:"compass_bearing",className:"text-lg",children:"Compass Bearing (0-360°)"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{type:"number",id:"compass_bearing",min:"0",max:"360",value:t.compass_bearing||"",onChange:ze,className:"w-32 text-center",disabled:i&&!a}),e.jsx("span",{className:"text-lg",children:"°"})]})]}),i&&e.jsxs("div",{className:"w-full space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{children:"Accuracy:"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(re,{value:_.accuracy*100,className:"w-24"}),e.jsx("span",{className:`w-3 h-3 rounded-full ${tt(_.accuracy)}`})]})]}),_.isGPSBased&&e.jsxs("div",{className:"text-sm text-blue-500",children:["Using GPS-based heading (Speed: ",_.speed.toFixed(1)," m/s)"]}),_.isErratic&&e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-red-500",children:[e.jsx(we,{className:"w-4 h-4"}),e.jsx("span",{children:"Compass readings are erratic. Please calibrate or use manual mode."})]})]}),p==="visual"&&s&&e.jsxs("div",{className:"relative w-full aspect-video",children:[e.jsx("video",{ref:T,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover rounded-lg"}),e.jsx("canvas",{ref:q,className:"hidden",width:640,height:480}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-32 h-32 border-2 border-white rounded-full opacity-50"})})]}),e.jsxs("div",{className:"text-sm text-gray-500 text-center max-w-md",children:["Enter the compass bearing in degrees, where:",e.jsxs("ul",{className:"mt-2 space-y-1",children:[e.jsx("li",{children:"0° or 360° = North"}),e.jsx("li",{children:"90° = East"}),e.jsx("li",{children:"180° = South"}),e.jsx("li",{children:"270° = West"})]})]})]})})})})}const Yt=()=>{const{formData:t,updateFormData:o,setIsPhotoUploading:i}=B(),[r,a]=n.useState(!1),d=n.useRef(null),s=async m=>{var b;const x=(b=m.target.files)==null?void 0:b[0];if(x){if(!x.type.startsWith("image/")){v.error("Please select an image file");return}if(x.size>5*1024*1024){v.error("Image size should be less than 5MB");return}console.log("handleFileChange: Starting photo upload process"),a(!0),i(!0),console.log("handleFileChange: isUploadingLocal and isPhotoUploading set to true");try{const g=x.name.split(".").pop(),h=`activity-photos/${`${Math.random()}.${g}`}`,u=Y.storage.from("photos").upload(h,x),y=new Promise((_,f)=>{const S=setTimeout(()=>{clearTimeout(S),f(new Error("Photo upload timed out (30 seconds)"))},3e4)}),p=await Promise.race([u,y]);if(p&&typeof p=="object"&&"error"in p&&p.error)throw console.error("handleFileChange: Supabase upload error:",p.error),p.error;if(p instanceof Error)throw console.error("handleFileChange: Timeout error:",p.message),v.error(p.message),p;const{data:{publicUrl:F}}=Y.storage.from("photos").getPublicUrl(h);o({photo_url:F}),console.log("handleFileChange: Photo uploaded successfully. Public URL:",F),v.success("Photo uploaded successfully")}catch(g){console.error("handleFileChange: Caught error during photo upload:",g),g instanceof Error&&g.message.includes("timed out")||v.error("Failed to upload photo. Please try again.")}finally{console.log("handleFileChange: Finally block executed. Setting isUploadingLocal and isPhotoUploading to false"),a(!1),i(!1)}}},l=()=>{d.current&&d.current.click()};return e.jsx("div",{className:"space-y-6",children:e.jsx(G,{children:e.jsx($,{className:"pt-6",children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(N,{children:"Photo"}),e.jsx("div",{className:"mt-2 flex flex-col items-center justify-center",children:t.photo_url?e.jsxs("div",{className:"relative w-full max-w-md",children:[e.jsx("img",{src:t.photo_url,alt:"Activity photo",className:"w-full h-64 object-cover rounded-lg"}),e.jsx(P,{variant:"destructive",size:"sm",className:"absolute top-2 right-2",onClick:()=>o({photo_url:void 0}),children:"Remove"})]}):e.jsxs("div",{className:"w-full max-w-md h-64 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center",children:[e.jsx(te,{className:"w-12 h-12 text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"No photo selected"}),e.jsxs(P,{onClick:l,disabled:r,children:[e.jsx(jt,{className:"w-4 h-4 mr-2"}),r?"Uploading...":"Upload Photo"]}),e.jsx("input",{ref:d,type:"file",accept:"image/*",onChange:s,className:"hidden"})]})})]})})})})})},M=[{type:"dateTimeLocation",title:"Date/Time & Location",icon:e.jsx(Ne,{className:"w-5 h-5"}),component:It},{type:"observationType",title:"Type of Observation",icon:e.jsx(vt,{className:"w-5 h-5"}),component:Wt},{type:"compassBearing",title:"Compass Bearing",icon:e.jsx(J,{className:"w-5 h-5"}),component:Xt},{type:"photo",title:"Photo",icon:e.jsx(te,{className:"w-5 h-5"}),component:Yt}],Jt=t=>t?(t instanceof Date?t:new Date(t)).toISOString().split("T")[0]:"",Qt=({onSubmit:t,isSubmitting:o})=>{var _;const{currentStep:i,formData:r,goToNextStep:a,goToPreviousStep:d,isStepValid:s,isLastStep:l,resetForm:m,isPhotoUploading:x}=B(),[b,g]=n.useState(!1),w=ve(),{user:h}=ye(),u=M.findIndex(f=>f.type===i),y=b||o,p=n.useCallback(async()=>{console.log("handleSubmit: Starting form submission.");try{if(g(!0),console.log("handleSubmit: isSubmitting set to true."),!r.activity_date||!r.activity_time||!r.observation_type){v.error("Please fill in all required fields");return}let f=(h==null?void 0:h.id)||null;if(!f){const{data:{session:C}}=await pt.auth.getSession();C!=null&&C.user&&(f=C.user.id)}const S=Jt(r.activity_date),O=r.activity_time||"",k={user_id:f||"",activity_date:new Date(S),activity_time:O,observation_type:r.observation_type,latitude:String(r.latitude||"0"),longitude:String(r.longitude||"0"),total_elephants:r.total_elephants?Number(r.total_elephants):void 0,male_elephants:r.male_elephants?Number(r.male_elephants):void 0,female_elephants:r.female_elephants?Number(r.female_elephants):void 0,unknown_elephants:r.unknown_elephants?Number(r.unknown_elephants):void 0,calves:r.calves?Number(r.calves):void 0,compass_bearing:r.compass_bearing?Number(r.compass_bearing):void 0,photo_url:r.photo_url||void 0,indirect_sighting_type:r.indirect_sighting_type,loss_type:r.loss_type};if(!k.observation_type)throw new Error("Observation type is required");if(!k.latitude||!k.longitude)throw new Error("Location is required");try{await t(k),v.success("Activity report submitted successfully"),m(),w("/")}catch(C){console.error("handleSubmit: Error submitting report:",C),v.error("Failed to submit report")}finally{g(!1),console.log("handleSubmit: Inner try-catch finally block. isSubmitting set to false.")}}catch(f){console.error("Error submitting activity report:",f),v.error(f.message||"Failed to submit report")}finally{g(!1),console.log("handleSubmit: Outer finally block. isSubmitting set to false.")}},[r,w,t,m,h]),F=((_=M.find(f=>f.type===i))==null?void 0:_.component)||null;return e.jsx("div",{className:"container mx-auto p-2 sm:p-4",children:e.jsxs(G,{className:"w-full max-w-full sm:max-w-2xl bg-white rounded-xl shadow-sm border border-gray-100 mx-auto",children:[e.jsxs(rt,{className:"space-y-4 sm:space-y-6 p-4 sm:p-6 border-b border-gray-100",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[e.jsx(ot,{className:"text-lg sm:text-2xl font-bold text-gray-900",children:"Elephant Watch Report"}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 w-full sm:w-auto",children:[e.jsxs("span",{className:"text-xs sm:text-sm font-medium text-gray-600",children:["Step ",u+1," of ",M.length]}),e.jsx(re,{value:(u+1)/M.length*100,className:"w-full sm:w-48 h-2 bg-gray-100"})]})]}),e.jsx("div",{className:"flex flex-nowrap overflow-x-auto gap-2 pb-2 sm:pb-0 -mx-2 sm:mx-0 px-2 sm:px-0",children:M.map((f,S)=>e.jsxs(P,{variant:S===u?"default":"outline",size:"sm",className:`flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md transition-colors whitespace-nowrap text-xs sm:text-sm
                  ${S===u?"bg-blue-600 hover:bg-blue-700 text-white border-blue-600":"bg-white hover:bg-gray-50 text-gray-600 border-gray-200"}`,disabled:S>u&&!s(M[S-1].type),children:[f.icon,f.title]},f.type))})]}),e.jsxs($,{className:"p-4 sm:p-6",children:[F&&e.jsx(F,{}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-100 gap-2 sm:gap-0",children:[e.jsx(P,{variant:"outline",onClick:d,disabled:u===0||y,className:"border-gray-200 text-gray-600 hover:bg-gray-50 w-full sm:w-auto",children:"Previous"}),l()?e.jsx(P,{onClick:p,disabled:(()=>{const f=!s(i)||y||x;return console.log(`Submit button disabled check: isStepValid(${i})=${s(i)}, isActuallySubmitting=${y}, isPhotoUploading=${x}. Result: ${f}`),f})(),className:"bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto",children:x?"Uploading Photo...":y?"Submitting...":"Submit Report"}):e.jsx(P,{onClick:a,disabled:!s(i)||y||x,className:"bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto",children:"Next"})]})]})]})})},Zt=t=>e.jsx(Rt,{children:e.jsx(e.Fragment,{children:e.jsx(Qt,{...t})})}),fs=()=>{const[t,o]=n.useState(!1),{user:i,loading:r}=ye(),a=ve();if(at.useEffect(()=>{!r&&!i&&a("/login")},[i,r,a]),r)return e.jsx("div",{className:"flex items-center justify-center h-screen",children:"Loading..."});if(!i)return null;const d=async s=>{o(!0);try{const{error:l}=await Y.from("activity_reports").insert([s]);if(l)throw l;v.success("Activity report submitted successfully"),a("/activities")}catch(l){console.error("Error submitting report:",l),v.error("Failed to submit report")}finally{o(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"container mx-auto p-2 sm:p-4",children:[e.jsxs("header",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold tracking-tight text-gray-900 sm:text-5xl",children:"Wild Elephant Monitoring System"}),e.jsx("h2",{className:"mt-2 text-2xl font-semibold text-gray-600",children:"जंगली हाथी निगरानी प्रणाली (2025)"})]}),e.jsx(G,{className:"mb-8 overflow-hidden border border-blue-100 bg-white shadow-sm",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(we,{className:"h-6 w-6 text-blue-600 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"निर्देश / Instructions:"}),e.jsxs("ul",{className:"space-y-3 text-gray-600",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["इस फॉर्म को चार चरणों में पूरा करें: तारीख/समय और स्थान, अवलोकन का प्रकार, कम्पास बेयरिंग, और फोटो।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Complete this form in four steps: Date/Time & Location, Type of Observation, Compass Bearing, and Photo."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["प्रत्येक चरण में आवश्यक जानकारी भरें और 'Next' बटन पर क्लिक करें। पिछले चरण पर जाने के लिए 'Previous' बटन का उपयोग करें।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Fill in the required information in each step and click 'Next'. Use 'Previous' to go back to earlier steps."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["GPS लोकेशन को Degree Decimal फॉर्मेट में भरें (उदाहरण: 23.4536 81.4763)। सटीक स्थान महत्वपूर्ण है।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Enter GPS location in Degree Decimal format (Example: 23.4536 81.4763). Accurate location is crucial."})]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600",children:"•"}),e.jsxs("span",{children:["अवलोकन के प्रकार के अनुसार, हाथियों की संख्या या अप्रत्यक्ष साक्ष्य का विवरण दें।",e.jsx("br",{}),e.jsx("span",{className:"text-gray-500",children:"Based on observation type, provide elephant count or indirect evidence details."})]})]})]})]})]})})}),e.jsx("main",{className:"max-w-4xl mx-auto",children:e.jsx(Zt,{onSubmit:d,isSubmitting:t})})]})})};export{fs as default};
//# sourceMappingURL=ReportActivityPage-BQs2VLNt.js.map
