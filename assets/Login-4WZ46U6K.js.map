{"version":3,"file":"Login-4WZ46U6K.js","sources":["../../src/lib/supabaseAdmin.ts","../../src/components/Login.tsx"],"sourcesContent":["import { supabase } from './supabaseClient';\n\n/**\n * The frontend should never expose the service-role key, but several legacy\n * components still import `supabaseAdmin` expecting a Supabase client with the\n * same API surface.  We therefore export the normal client under that name.\n *\n * TODO: migrate those components to import { supabase } from '@/lib/supabaseClient'\n * directly and remove this shim.\n */\nexport const supabaseAdmin = supabase; ","import React, { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { supabaseAdmin } from \"@/lib/supabaseAdmin\";\nimport { toast } from \"sonner\";\nimport { Loader2 } from \"lucide-react\";\nimport { useNavigate, useLocation } from \"react-router-dom\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useAuth } from '@/hooks/useAuth';\nimport { checkSupabaseConnection } from \"@/lib/supabaseClient\";\nimport { motion } from \"framer-motion\";\n\n// Helper to get browser info\nfunction getBrowserInfo() {\n  return navigator.userAgent;\n}\n\n// Helper to get IP address\nasync function getIpAddress() {\n  try {\n    const res = await fetch('https://api.ipify.org?format=json');\n    const data = await res.json();\n    return data.ip;\n  } catch {\n    return '';\n  }\n}\n\nconst logLoginAttempt = async (identifier: string, status: 'success' | 'failed') => {\n  try {\n    const { data: browserInfo } = await supabaseAdmin.rpc('get_browser_info');\n    const { data: ipInfo } = await supabaseAdmin.rpc('get_ip_info');\n\n    const isEmail = identifier.includes('@');\n    const ip = ipInfo && typeof ipInfo === 'object' && ipInfo !== null && 'ip' in ipInfo ? ipInfo.ip : null;\n    const userAgent = browserInfo && typeof browserInfo === 'object' && browserInfo !== null && 'user_agent' in browserInfo ? browserInfo.user_agent : null;\n    const loginData = {\n      user_identifier: identifier,\n      email: isEmail ? identifier : null,\n      phone: !isEmail ? identifier : null,\n      login_type: isEmail ? 'email' : 'phone',\n      status,\n      time: new Date().toISOString(),\n      ip,\n      browser: userAgent\n    };\n\n    const { error } = await supabaseAdmin\n      .from('login_logs')\n      .insert([loginData]);\n\n    if (error) {\n      console.error('Error logging login attempt:', error);\n    }\n  } catch (error) {\n    console.error('Error logging login attempt:', error);\n  }\n};\n\nexport default function Login() {\n  const [identifier, setIdentifier] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [rememberMe, setRememberMe] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const navigate = useNavigate();\n  const location = useLocation();\n  const { signIn, error: authError } = useAuth();\n\n  useEffect(() => {\n    // Only check connection for informational purposes\n    const checkConnection = async () => {\n      try {\n        const isConnected = await checkSupabaseConnection();\n        // Don't show any errors about connectivity - app will work offline\n        if (!isConnected) {\n          console.log(\"Working in offline mode\");\n        }\n      } catch (error) {\n        // Silently handle connection errors\n        console.log(\"Connection check error, continuing in offline mode if possible\");\n      }\n    };\n    checkConnection();\n  }, []);\n\n  const validateIdentifier = (value: string) => {\n    // Check if it's an email\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    // Check if it's a phone number\n    const phoneRegex = /^\\d{10}$/;\n    \n    return emailRegex.test(value) || phoneRegex.test(value);\n  };\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n    setError(null);\n\n    try {\n      // Validate identifier\n      if (!validateIdentifier(identifier)) {\n        setError(\"Please enter a valid email or phone number\");\n        setIsLoading(false);\n        return;\n      }\n\n      console.log('Starting login process for:', identifier);\n\n      // Always set the rememberMe flag to true for 30-day persistence\n      const shouldRemember = true; // Force remember me to be true for offline support\n      \n      // Attempt to sign in\n      console.log('Calling signIn with:', { identifier, shouldRemember });\n      const { user, error } = await signIn(identifier, password, shouldRemember);\n      console.log('Sign in result:', { user, error });\n      \n      if (error) {\n        throw error;\n      }\n\n      if (!user) {\n        throw new Error('No user data received after login');\n      }\n\n      // Try to log successful login attempt - don't fail if this doesn't work offline\n      try {\n        await logLoginAttempt(identifier, 'success');\n      } catch (logError) {\n        console.log('Unable to log login attempt (possibly offline)');\n      }\n      \n      // Always redirect to home page after login regardless of previous location\n      const redirectPath = '/';\n      console.log(\"Login successful, redirecting to home page\");\n      \n      // Navigate to the home page\n      navigate(redirectPath, { replace: true });\n    } catch (err) {\n      console.error(\"Login error:\", err);\n      const errorMessage = err instanceof Error ? err.message : \"An unknown error occurred during login\";\n      \n      // Type assertion for the error object\n      const errorObj = err as any;\n      console.error(\"Error details:\", {\n        error: err,\n        name: errorObj?.name,\n        code: errorObj?.code,\n        status: errorObj?.status,\n        response: errorObj?.response\n      });\n      setError(errorMessage);\n      toast.error(errorMessage);\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 via-white to-blue-50\">\n      <div className=\"container mx-auto py-12 px-4\">\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"text-center mb-16\"\n        >\n          <div className=\"flex items-center justify-center mb-8\">\n            <img\n              src={`${import.meta.env.BASE_URL}elephant_photo.png`}\n              alt=\"Elephant Logo\"\n              className=\"w-24 h-24 object-contain\"\n            />\n          </div>\n          <motion.h1 \n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ duration: 0.5, delay: 0.3 }}\n            className=\"text-6xl font-bold mb-6 bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent\"\n          >\n            Eravat\n          </motion.h1>\n          <motion.p \n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ duration: 0.5, delay: 0.4 }}\n            className=\"text-xl text-gray-600 max-w-2xl mx-auto\"\n          >\n            Wild Elephant Monitoring System\n          </motion.p>\n          <motion.p \n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ duration: 0.5, delay: 0.5 }}\n            className=\"text-lg text-gray-500 mt-2\"\n          >\n            जंगली हाथी निगरानी प्रणाली (2025)\n          </motion.p>\n        </motion.div>\n\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5, delay: 0.6 }}\n          className=\"max-w-md mx-auto\"\n        >\n          <Card className=\"bg-white shadow-lg border-0 rounded-2xl overflow-hidden\">\n            <CardHeader className=\"space-y-1\">\n              <CardTitle className=\"text-2xl font-bold text-gray-900\">Welcome back</CardTitle>\n              <CardDescription className=\"text-gray-600\">\n                Enter your email or phone number to access the system\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleLogin} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"identifier\" className=\"text-gray-700\">Email or Phone Number</Label>\n                  <Input\n                    id=\"identifier\"\n                    type=\"text\"\n                    placeholder=\"Enter email or 10-digit phone number\"\n                    value={identifier}\n                    onChange={(e) => setIdentifier(e.target.value)}\n                    required\n                    className=\"focus:ring-blue-600 border-gray-200\"\n                    disabled={isLoading}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"password\" className=\"text-gray-700\">Password</Label>\n                  <Input\n                    id=\"password\"\n                    type=\"password\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    required\n                    className=\"focus:ring-blue-600 border-gray-200\"\n                    disabled={isLoading}\n                  />\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id=\"remember\"\n                    checked={rememberMe}\n                    onCheckedChange={(checked) => setRememberMe(checked as boolean)}\n                    disabled={isLoading}\n                    className=\"border-gray-200\"\n                  />\n                  <Label htmlFor=\"remember\" className=\"text-sm font-normal text-gray-600\">\n                    Remember me\n                  </Label>\n                </div>\n                <Button \n                  type=\"submit\" \n                  className=\"w-full bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-700 hover:to-green-700 text-white rounded-xl py-6 text-lg font-semibold transition-all duration-300\" \n                  disabled={isLoading}\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Logging in...\n                    </>\n                  ) : (\n                    \"Login\"\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </div>\n    </div>\n  );\n}"],"names":["supabaseAdmin","supabase","logLoginAttempt","identifier","status","browserInfo","ipInfo","isEmail","ip","userAgent","loginData","error","Login","setIdentifier","useState","password","setPassword","isLoading","setIsLoading","rememberMe","setRememberMe","setError","navigate","useNavigate","useLocation","signIn","useAuth","useEffect","checkSupabaseConnection","validateIdentifier","value","emailRegex","phoneRegex","handleLogin","e","shouldRemember","user","redirectPath","err","errorMessage","errorObj","toast","jsxs","motion","jsx","Card","CardHeader","CardTitle","CardDescription","CardContent","Label","Input","Checkbox","checked","Button","Fragment","Loader2"],"mappings":"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"}